<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lost Pins</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin></script>

  <style>
    @keyframes toastIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
    @keyframes toastOut{from{opacity:1}to{transform:translateY(-10px);opacity:0}}
    @keyframes rankUp{0%{transform:scale(.7);opacity:0}50%{transform:scale(1.12)}100%{transform:scale(1);opacity:1}}
    @keyframes xpPop{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
    @keyframes gentlePulse{0%,100%{opacity:.85}50%{opacity:1}}

    :root{
      --sidebar-w:400px;
      --bg:#fafafa; --bg-elev:#ffffff; --bg-panel:#ffffff;
      --fg:#262626; --muted:#8e8e8e; --bright:#000;
      --accent:#ff6b6b; --accent-light:#fff0f0;
      --purple:#a855f7; --purple-light:#f3e8ff;
      --blue:#3b82f6; --blue-light:#eff6ff;
      --green:#22c55e; --green-light:#f0fdf4;
      --orange:#f59e0b; --orange-light:#fffbeb;
      --pink:#ec4899; --pink-light:#fdf2f8;
      --cat:#f59e0b; --dog:#22c55e; --pet:#06b6d4; --item:#a855f7; --danger:#ef4444;
      --found:#22c55e; --lost:#a855f7;
      --border:#efefef; --border-strong:#dbdbdb;
      --shadow-sm:0 1px 2px rgba(0,0,0,.05); --shadow:0 4px 12px rgba(0,0,0,.08); --shadow-lg:0 12px 32px rgba(0,0,0,.12);
      --radius:16px; --radius-sm:12px; --radius-xs:8px;
      --font:'DM Sans',sans-serif; --font-display:'Nunito',sans-serif;
    }
    [data-theme="dark"]{
      --bg:#0f1115; --bg-elev:#1a1d24; --bg-panel:#1a1d24;
      --fg:#e0e4ea; --muted:#7a8290; --bright:#fff;
      --accent:#ff7b7b; --accent-light:#2d1a1a;
      --purple:#b47aff; --purple-light:#1f162e;
      --blue:#5b9bff; --blue-light:#141d2e;
      --green:#3dd676; --green-light:#122118;
      --orange:#ffb840; --orange-light:#261e0e;
      --pink:#f472b6; --pink-light:#261425;
      --border:#2a2d35; --border-strong:#383c46;
      --shadow-sm:0 1px 3px rgba(0,0,0,.3); --shadow:0 4px 12px rgba(0,0,0,.4); --shadow-lg:0 12px 32px rgba(0,0,0,.5);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
      font-family:var(--font);font-weight:400;font-size:15px;-webkit-font-smoothing:antialiased}

    #app{display:grid;grid-template-columns:var(--sidebar-w) 1fr;grid-template-rows:auto 1fr;height:100vh}
    #resourceBar{grid-column:1/-1}
    #sidebar{background:var(--bg-elev);border-right:1px solid var(--border);display:flex;flex-direction:column;
      min-width:calc(var(--sidebar-w) - 40px)}
    #map{height:100%;width:100%}

    #resourceBar{background:var(--bg-elev);border-bottom:1px solid var(--border);padding:0 20px;
      display:flex;align-items:center;height:52px;gap:0;box-shadow:var(--shadow-sm)}
    .res-group{display:flex;align-items:center;gap:6px;padding:8px 16px;
      font-size:13px;color:var(--muted);white-space:nowrap;border-right:1px solid var(--border)}
    .res-group:last-child{border-right:none}
    .res-icon{font-size:18px}
    .res-val{color:var(--fg);font-weight:700;font-size:15px;font-family:var(--font-display)}
    .res-val.gold{color:var(--orange)}
    .res-label{font-size:11px;color:var(--muted);font-weight:500}
    .res-rank{display:flex;align-items:center;gap:8px;margin-left:auto;padding:6px 14px;
      border-radius:999px;font-family:var(--font-display);font-size:12px;font-weight:700;
      color:var(--orange);background:var(--orange-light);border:1px solid rgba(245,158,11,.2)}
    .xp-bar-wrap{width:80px;height:5px;background:var(--border);border-radius:999px;overflow:hidden}
    .xp-bar-fill{height:100%;background:linear-gradient(90deg,var(--orange),var(--pink));border-radius:999px;transition:width .6s ease}

    .brand{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .brand .title{font-family:var(--font-display);font-weight:800;font-size:20px;
      background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .brand .who{display:block;font-size:12px;color:var(--muted);margin-top:2px}
    .brand .left{display:flex;flex-direction:column}

    .controls{padding:12px 16px;border-bottom:1px solid var(--border);display:grid;grid-template-columns:1fr auto;gap:8px}
    .controls input[type="text"]{background:var(--bg);border:1px solid var(--border-strong);color:var(--fg);
      padding:10px 14px;border-radius:var(--radius);font-family:var(--font);font-size:14px;transition:all .2s}
    .controls input[type="text"]:focus{border-color:var(--accent);outline:none;box-shadow:0 0 0 3px rgba(255,107,107,.12)}
    .controls .row{grid-column:1/-1;display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    button,label.btn{background:var(--bg);border:1px solid var(--border-strong);color:var(--fg);
      padding:8px 14px;border-radius:var(--radius);cursor:pointer;font-size:13px;font-family:var(--font);
      font-weight:600;transition:all .15s ease}
    button:hover,label.btn:hover{background:var(--bg);border-color:var(--border-strong);box-shadow:var(--shadow-sm)}
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    button.primary:hover{background:#ff5252;box-shadow:0 4px 12px rgba(255,107,107,.3)}
    button.danger{border-color:#fca5a5;background:#fef2f2;color:#dc2626}
    button[disabled]{opacity:.45;cursor:not-allowed}

    #locationList{list-style:none;padding:0;margin:0;overflow:auto;flex:1}
    .loc{border-bottom:1px solid var(--border);padding:14px 16px;display:grid;grid-template-columns:1fr;row-gap:8px;
      transition:background .12s;cursor:pointer}
    .loc:hover{background:var(--bg)}
    .loc .title-row{display:flex;align-items:center;gap:8px;min-width:0}
    .loc .title-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:600;font-size:14px}
    .loc .meta{color:var(--muted);font-size:12px}
    .loc .actions-row{display:flex;gap:6px;flex-wrap:wrap}

    .badge{font-size:11px;padding:3px 10px;border-radius:999px;font-weight:600}
    .badge.cat{background:#fffbeb;color:#b45309;border:1px solid #fde68a}
    .badge.dog{background:#f0fdf4;color:#15803d;border:1px solid #bbf7d0}
    .badge.pet{background:#ecfeff;color:#0e7490;border:1px solid #a5f3fc}
    .badge.item{background:#f3e8ff;color:#7e22ce;border:1px solid #d8b4fe}
    .badge.danger{background:#fef2f2;color:#dc2626;border:1px solid #fca5a5}

    .status-pill{font-size:11px;padding:3px 10px;border-radius:999px;font-weight:600}
    .status-open{background:var(--blue-light);color:#1d4ed8;border:1px solid #bfdbfe}
    .status-found{background:var(--green-light);color:#15803d;border:1px solid #bbf7d0}
    .status-lost{background:var(--purple-light);color:#7e22ce;border:1px solid #d8b4fe}

    .pin-hint{position:absolute;top:12px;right:12px;z-index:500;
      background:var(--bg-elev);border:1px solid var(--border-strong);padding:10px 16px;border-radius:var(--radius);
      color:var(--fg);font-size:13px;font-weight:600;pointer-events:none;box-shadow:var(--shadow);
      animation:gentlePulse 2s ease infinite}

    #gate{position:fixed;inset:0;background:linear-gradient(160deg,#fff5f5 0%,#faf5ff 40%,#eff6ff 100%);
      display:grid;place-items:center;z-index:2000}
    #gate .card{width:min(420px,88%);background:var(--bg-elev);border:1px solid var(--border);
      border-radius:24px;padding:40px 32px;display:flex;flex-direction:column;align-items:center;
      box-shadow:var(--shadow-lg)}
    #gate h2{margin:0 0 4px 0;font-family:var(--font-display);font-weight:800;font-size:28px;
      background:linear-gradient(135deg,var(--accent),var(--purple),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    #gate .muted{color:var(--muted);font-size:14px;margin-bottom:24px;text-align:center}
    #gate #googleBtn{font-family:var(--font-display);font-weight:700;font-size:14px;padding:12px 28px;
      border-radius:999px;background:var(--fg);color:#fff;border:none}
    #gate #googleBtn:hover{background:#444;box-shadow:var(--shadow)}
    .stack{display:grid;gap:10px}
    .error{color:#dc2626;font-size:13px;min-height:18px}
    .ok{color:var(--green)}
    .gate-foot{margin-top:20px;border-top:1px solid var(--border);padding-top:14px;color:var(--muted);font-size:12px;text-align:center}
    body.auth #gate{display:none}
    body:not(.auth) #app{filter:blur(6px);pointer-events:none;user-select:none}
    body:not(.auth) #resourceBar{display:none}

    .modal-backdrop[hidden]{display:none}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:grid;place-items:center;z-index:3000;padding:16px;
      backdrop-filter:blur(8px)}
    .modal{width:min(600px,100%);background:var(--bg-elev);border:1px solid var(--border);border-radius:var(--radius);
      padding:24px;box-shadow:var(--shadow-lg)}
    .modal h3{margin:0 0 14px 0;font-family:var(--font-display);font-size:18px;font-weight:700;color:var(--fg)}
    .terms-body{max-height:60vh;overflow:auto;background:var(--bg);border:1px solid var(--border);padding:14px;border-radius:var(--radius-sm)}
    .modal .f{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
    .modal .f label{font-size:12px;color:var(--muted);margin-bottom:4px;display:block;font-weight:600}
    .modal input[type="text"],.modal textarea{width:100%;background:var(--bg);
      border:1px solid var(--border-strong);color:var(--fg);padding:10px 14px;border-radius:var(--radius-sm);outline:none;resize:vertical;
      font-family:var(--font);font-size:14px;transition:all .2s}
    .modal input[type="text"]:focus,.modal textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,107,107,.1)}
    .modal textarea{min-height:80px;grid-column:1/-1}
    .type-group{display:none}
    .photo-prev{grid-column:1/-1;width:100%;max-height:220px;object-fit:cover;border-radius:var(--radius-sm);display:none;border:1px solid var(--border)}
    .mini-note{grid-column:1/-1;color:var(--muted);font-size:12px}

    .pin-icon{background:transparent!important;border:0!important}
    .pin{position:relative;width:46px;height:60px;pointer-events:auto}
    .pin .bubble{width:46px;height:46px;border-radius:50%;overflow:hidden;background:#fff;
      display:flex;align-items:center;justify-content:center;border:3px solid #fff;
      box-shadow:0 2px 8px rgba(0,0,0,.2),0 0 0 1px rgba(0,0,0,.05)}
    .pin .bubble img.thumb{width:100%;height:100%;object-fit:cover;display:block}
    .pin .bubble .glyph{font-size:22px;line-height:1}
    .pin .stem{position:absolute;left:50%;bottom:4px;transform:translateX(-50%);
      width:0;height:0;border-left:9px solid transparent;border-right:9px solid transparent;
      border-top:14px solid #fff;filter:drop-shadow(0 1px 2px rgba(0,0,0,.15))}
    .pin .pin-name{position:absolute;left:50%;bottom:-14px;transform:translateX(-50%);
      font-size:10px;font-weight:700;color:var(--fg);white-space:nowrap;max-width:90px;overflow:hidden;text-overflow:ellipsis;
      background:#fff;padding:1px 6px;border-radius:6px;text-align:center;pointer-events:none;
      box-shadow:0 1px 4px rgba(0,0,0,.1)}
    .pin.cat .bubble{border-color:var(--cat);box-shadow:0 2px 8px rgba(245,158,11,.3)}
    .pin.cat .stem{border-top-color:var(--cat)}
    .pin.dog .bubble{border-color:var(--dog);box-shadow:0 2px 8px rgba(34,197,94,.3)}
    .pin.dog .stem{border-top-color:var(--dog)}
    .pin.pet .bubble{border-color:var(--pet);box-shadow:0 2px 8px rgba(6,182,212,.3)}
    .pin.pet .stem{border-top-color:var(--pet)}
    .pin.item .bubble{border-color:var(--item);box-shadow:0 2px 8px rgba(168,85,247,.3)}
    .pin.item .stem{border-top-color:var(--item)}
    .pin.danger .bubble{border-color:var(--danger);box-shadow:0 2px 8px rgba(239,68,68,.3)}
    .pin.danger .stem{border-top-color:var(--danger)}

    .leaflet-tooltip.pin-tooltip{background:#fff;color:var(--fg);border:1px solid var(--border);
      border-radius:var(--radius-sm);box-shadow:var(--shadow)}
    .tt-title{margin-bottom:4px;font-weight:700}.tt-meta{color:var(--muted);font-size:12px;margin-bottom:4px}.tt-desc{font-size:13px;max-width:260px;white-space:normal}

    #topbar{position:fixed;top:0;left:0;right:0;z-index:1200;
      background:rgba(255,255,255,.92);backdrop-filter:blur(12px);
      border-bottom:1px solid var(--border);display:none;align-items:center;justify-content:space-between;padding:10px 14px}
    #topbar .title{font-family:var(--font-display);font-weight:800;font-size:16px;
      background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    #topbar .who{font-size:11px;color:var(--muted)}

    #bottomBar{position:fixed;left:0;right:0;bottom:0;z-index:1200;
      background:rgba(255,255,255,.92);backdrop-filter:blur(12px);
      border-top:1px solid var(--border);display:none;gap:6px;padding:8px 8px calc(env(safe-area-inset-bottom) + 8px)}
    .mode-strip{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none}
    .mode-strip::-webkit-scrollbar{display:none}
    .mode-btn .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:-1px}
    .mode-btn.cat .dot{background:var(--cat)}.mode-btn.dog .dot{background:var(--dog)}
    .mode-btn.pet .dot{background:var(--pet)}.mode-btn.item .dot{background:var(--item)}.mode-btn.dang .dot{background:var(--danger)}
    .action-row{display:flex;gap:8px;overflow:auto}

    @media(max-width:1040px){
      #app{grid-template-columns:1fr;grid-template-rows:auto auto 1fr}
      #sidebar{display:none}
      #topbar{display:flex}
      #bottomBar{display:grid}
      #map{height:100vh}
      body:not(.auth) #app{filter:none}
      #resourceBar{height:42px;padding:0 10px;overflow-x:auto;scrollbar-width:none}
      #resourceBar::-webkit-scrollbar{display:none}
      .res-group{padding:4px 10px;font-size:12px}
      .res-label{display:none}
      .res-rank{padding:4px 10px;font-size:11px}
      .xp-bar-wrap{width:50px}
    }

    #inAppWarning{display:none;position:fixed;bottom:64px;left:0;right:0;z-index:1300;
      background:#fef2f2;color:#dc2626;border-top:1px solid #fca5a5;padding:10px 14px;font-size:13px;font-weight:500}
    .leaflet-container{background:#e8e8e8}

    .time-filter{display:flex;gap:6px;flex-wrap:wrap;grid-column:1/-1}
    .time-filter button{font-size:12px;padding:6px 12px;border-radius:999px}
    .time-filter button.active{background:var(--accent);border-color:var(--accent);color:#fff}

    .reward-badge{display:inline-block;font-size:12px;padding:3px 10px;border-radius:999px;
      background:var(--orange-light);color:#b45309;border:1px solid #fde68a;font-weight:600}
    .contact-pill{display:inline-flex;align-items:center;gap:4px;font-size:12px;padding:4px 12px;
      border-radius:999px;background:var(--green-light);color:#15803d;border:1px solid #bbf7d0;
      cursor:pointer;text-decoration:none;font-weight:600;transition:all .15s}
    .contact-pill:hover{filter:brightness(1.05);box-shadow:var(--shadow-sm)}

    .popup-action{display:inline-block;font-size:12px;padding:5px 12px;border-radius:999px;
      border:1px solid var(--border-strong);background:var(--bg-elev);color:var(--fg);cursor:pointer;
      text-decoration:none;font-weight:600;transition:all .12s}
    .popup-action:hover{background:var(--bg);box-shadow:var(--shadow-sm)}
    .popup-action.share{background:var(--blue-light);border-color:#bfdbfe;color:#1d4ed8}
    .popup-action.share:hover{filter:brightness(1.05)}
    .popup-action.sight{background:var(--orange-light);border-color:#fde68a;color:#b45309}
    .popup-action.sight:hover{filter:brightness(1.05)}
    .popup-action.flyer{background:var(--purple-light);border-color:#d8b4fe;color:#7e22ce}
    .popup-action.flyer:hover{filter:brightness(1.05)}

    .lang-toggle{position:fixed;bottom:16px;right:16px;z-index:9999;background:var(--bg-elev);color:var(--fg);
      border:1px solid var(--border-strong);border-radius:999px;padding:8px 16px;font-size:13px;cursor:pointer;
      font-weight:700;box-shadow:var(--shadow);transition:all .2s}
    .lang-toggle:hover{background:var(--bg)}
    [dir="rtl"] .sidebar{direction:rtl;text-align:right}
    [dir="rtl"] .controls input{text-align:right}
    [dir="rtl"] .type-group{direction:rtl}
    [dir="rtl"] .lang-toggle{right:auto;left:16px}

    .notif-toggle{background:var(--bg-elev);border:1px solid var(--border-strong);border-radius:var(--radius);padding:5px 12px;
      font-size:15px;cursor:pointer;color:var(--muted);transition:all .15s}
    .notif-toggle.active{color:var(--orange);border-color:var(--orange);background:var(--orange-light)}
    .notif-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}

    .avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.1);flex-shrink:0}
    .avatar-sm{width:22px;height:22px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 1px 2px rgba(0,0,0,.08);flex-shrink:0;vertical-align:middle}
    .avatar-lg{width:48px;height:48px;border-radius:50%;object-fit:cover;border:3px solid #fff;cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,.12)}
    .avatar-placeholder{display:inline-flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--accent),var(--purple));color:#fff;font-weight:700;font-size:12px;font-family:var(--font-display)}
    .avatar-placeholder.sm{font-size:9px}
    .profile-row{display:flex;align-items:center;gap:12px;padding:12px 20px;border-bottom:1px solid var(--border)}
    .profile-row .name{font-weight:700;font-size:15px;font-family:var(--font-display);color:var(--fg)}
    .profile-row .email{font-size:12px;color:var(--muted)}
    .profile-edit-btn{font-size:11px;padding:4px 12px;border-radius:999px;background:var(--bg);
      color:var(--muted);border:1px solid var(--border-strong);cursor:pointer;font-weight:600}
    .profile-edit-btn:hover{filter:brightness(.95);color:var(--fg)}

    .sightings-list{margin-top:6px;max-height:120px;overflow:auto}
    .sighting-item{font-size:12px;color:var(--muted);padding:4px 0;border-bottom:1px solid var(--border)}
    .sighting-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--orange);margin-right:5px;vertical-align:middle}

    #toastContainer{position:fixed;top:60px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none}
    .toast{pointer-events:auto;display:flex;align-items:center;gap:12px;padding:14px 18px;
      background:var(--bg-elev);border:1px solid var(--border);border-radius:var(--radius);
      box-shadow:var(--shadow-lg);animation:toastIn .35s ease forwards;min-width:280px;max-width:380px}
    .toast.out{animation:toastOut .25s ease forwards}
    .toast-icon{font-size:32px;animation:rankUp .4s ease}
    .toast-body{flex:1}
    .toast-title{font-family:var(--font-display);font-size:13px;font-weight:800;color:var(--fg);margin-bottom:1px}
    .toast-desc{font-size:12px;color:var(--muted)}
    .toast-xp{font-size:12px;font-weight:700;color:var(--orange);animation:xpPop .5s ease}

    .leaflet-popup-content-wrapper{background:#fff!important;color:var(--fg)!important;
      border:1px solid var(--border)!important;border-radius:var(--radius)!important;
      box-shadow:var(--shadow-lg)!important;font-family:var(--font)!important}
    .leaflet-popup-tip{background:#fff!important;border:1px solid var(--border)!important}
    .leaflet-popup-close-button{color:var(--muted)!important;font-size:18px!important}
    .leaflet-popup-close-button:hover{color:var(--fg)!important}

    ::-webkit-scrollbar{width:6px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:var(--border-strong);border-radius:999px}
    ::-webkit-scrollbar-thumb:hover{background:var(--muted)}

    /* â•â•â• DARK MODE OVERRIDES â•â•â• */
    [data-theme="dark"] #gate{background:linear-gradient(160deg,#1a1015 0%,#151020 40%,#101520 100%)}
    [data-theme="dark"] #gate .card{background:var(--bg-elev);border-color:var(--border-strong)}
    [data-theme="dark"] #gate #googleBtn{background:#e0e4ea;color:#1a1d24}
    [data-theme="dark"] #gate #googleBtn:hover{background:#fff}
    [data-theme="dark"] button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    [data-theme="dark"] button.primary:hover{background:#ff5252}
    [data-theme="dark"] .pin .bubble{background:var(--bg-elev);border-color:var(--border-strong)}
    [data-theme="dark"] .pin .stem{border-top-color:var(--border-strong)}
    [data-theme="dark"] .pin.cat .bubble{border-color:var(--cat)}[data-theme="dark"] .pin.cat .stem{border-top-color:var(--cat)}
    [data-theme="dark"] .pin.dog .bubble{border-color:var(--dog)}[data-theme="dark"] .pin.dog .stem{border-top-color:var(--dog)}
    [data-theme="dark"] .pin.pet .bubble{border-color:var(--pet)}[data-theme="dark"] .pin.pet .stem{border-top-color:var(--pet)}
    [data-theme="dark"] .pin.item .bubble{border-color:var(--item)}[data-theme="dark"] .pin.item .stem{border-top-color:var(--item)}
    [data-theme="dark"] .pin.danger .bubble{border-color:var(--danger)}[data-theme="dark"] .pin.danger .stem{border-top-color:var(--danger)}
    [data-theme="dark"] .pin .pin-name{background:var(--bg-elev);color:var(--fg);box-shadow:0 1px 4px rgba(0,0,0,.3)}
    [data-theme="dark"] .avatar{border-color:var(--bg-elev)}
    [data-theme="dark"] .avatar-sm{border-color:var(--bg-elev)}
    [data-theme="dark"] .avatar-lg{border-color:var(--border-strong)}
    [data-theme="dark"] .leaflet-popup-content-wrapper{background:var(--bg-elev)!important;color:var(--fg)!important;border-color:var(--border-strong)!important}
    [data-theme="dark"] .leaflet-popup-tip{background:var(--bg-elev)!important;border-color:var(--border-strong)!important}
    [data-theme="dark"] .popup-action.share{background:var(--blue-light);border-color:rgba(91,155,255,.25);color:var(--blue)}
    [data-theme="dark"] .popup-action.sight{background:var(--orange-light);border-color:rgba(255,184,64,.25);color:var(--orange)}
    [data-theme="dark"] .popup-action.flyer{background:var(--purple-light);border-color:rgba(180,122,255,.25);color:var(--purple)}
    [data-theme="dark"] .badge.cat{background:var(--orange-light);color:var(--orange);border-color:rgba(255,184,64,.25)}
    [data-theme="dark"] .badge.dog{background:var(--green-light);color:var(--green);border-color:rgba(61,214,118,.25)}
    [data-theme="dark"] .badge.pet{background:rgba(6,182,212,.1);color:#40d0e0;border-color:rgba(6,182,212,.25)}
    [data-theme="dark"] .badge.item{background:var(--purple-light);color:var(--purple);border-color:rgba(180,122,255,.25)}
    [data-theme="dark"] .badge.danger{background:rgba(239,68,68,.1);color:#ff8080;border-color:rgba(239,68,68,.25)}
    [data-theme="dark"] .status-open{background:var(--blue-light);color:var(--blue);border-color:rgba(91,155,255,.25)}
    [data-theme="dark"] .status-found{background:var(--green-light);color:var(--green);border-color:rgba(61,214,118,.25)}
    [data-theme="dark"] .status-lost{background:var(--purple-light);color:var(--purple);border-color:rgba(180,122,255,.25)}
    [data-theme="dark"] .leaflet-container{background:#181c22}
    [data-theme="dark"] #topbar{background:rgba(26,29,36,.92)}
    [data-theme="dark"] #bottomBar{background:rgba(26,29,36,.92)}
    [data-theme="dark"] .leaflet-tooltip.pin-tooltip{background:var(--bg-elev);color:var(--fg);border-color:var(--border-strong)}
    [data-theme="dark"] .modal{background:var(--bg-elev);border-color:var(--border-strong)}
    [data-theme="dark"] .modal input[type="text"],[data-theme="dark"] .modal textarea{background:var(--bg);border-color:var(--border-strong);color:var(--fg)}
    [data-theme="dark"] .controls input[type="text"]{background:var(--bg);border-color:var(--border-strong)}

    /* Theme toggle */
    .theme-toggle{position:fixed;bottom:16px;right:72px;z-index:9999;background:var(--bg-elev);color:var(--fg);
      border:1px solid var(--border-strong);border-radius:999px;padding:8px 14px;font-size:16px;cursor:pointer;
      box-shadow:var(--shadow);transition:all .2s;line-height:1}
    .theme-toggle:hover{background:var(--bg);transform:scale(1.05)}
    [dir="rtl"] .theme-toggle{right:auto;left:72px}
  </style>
</head>
<body>
  <!-- Login Gate -->
  <div id="gate">
    <div class="card">
      <h2>Lost Pins</h2>
      <div class="muted">Sign in with Google to continue</div>
      <div class="stack">
        <button id="googleBtn" class="primary">Continue with Google</button>
        <div id="gateInfo" class="ok"></div>
        <div id="gateError" class="error"></div>
      </div>
      <div class="gate-foot">
        <small style="opacity:.65">
          Track Â· Report Â· Reunite<br>
          by Ahzek Ahriman
        </small>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <div id="app">
    <!-- Resource Bar (Stellaris-style) -->
    <div id="resourceBar">
      <div class="res-group"><span class="res-icon">ğŸ“Œ</span><span class="res-val" id="statPins">0</span><span class="res-label">Pins</span></div>
      <div class="res-group"><span class="res-icon">ğŸ‘ï¸</span><span class="res-val" id="statSightings">0</span><span class="res-label">Sightings</span></div>
      <div class="res-group"><span class="res-icon">âœ…</span><span class="res-val" id="statResolved">0</span><span class="res-label">Resolved</span></div>
      <div class="res-group"><span class="res-icon">âš¡</span><span class="res-val gold" id="statXP">0</span><span class="res-label">XP</span></div>
      <div class="res-rank" id="rankBadge">
        <span id="rankIcon">ğŸ”°</span>
        <span id="rankTitle">SCOUT</span>
        <div class="xp-bar-wrap"><div class="xp-bar-fill" id="xpBarFill" style="width:0%"></div></div>
      </div>
    </div>
    <!-- Desktop sidebar -->
    <aside id="sidebar">
      <div class="brand">
        <div class="left">
          <div class="title">Lost Pins</div>
          <div id="whoami" class="who"></div>
        </div>
        <button id="logoutBtn">Sign out</button>
      </div>
      <div class="profile-row" id="profileRow" style="display:none;padding:8px 16px">
        <img id="profileAvatar" class="avatar-lg" src="" alt="" title="Click to change photo">
        <div style="flex:1;min-width:0">
          <div id="profileName" class="name"></div>
          <div id="profileEmail" class="email"></div>
        </div>
        <button id="changeAvatarBtn" class="profile-edit-btn">ğŸ“· Change</button>
        <input id="avatarInput" type="file" accept="image/*" style="display:none">
      </div>
      <div class="controls">
        <input id="searchInput" type="text" placeholder="Search a place (e.g., KAUST, Jeddah)" />
        <button id="searchBtn" title="Find place">Search</button>
        <div class="row">
          <button id="locateBtn" title="Center on my location">Locate me</button>
          <button id="deleteAllBtn" class="danger">Delete All Pins (mine)</button>
          <button id="openUsersBtn" style="display:none">Users</button>
        </div>
        <div class="row">
          <button id="modeCatBtn"   class="mode-btn cat"><span class="dot"></span>Lost Cat</button>
          <button id="modeDogBtn"   class="mode-btn dog"><span class="dot"></span>Lost Dog</button>
          <button id="modePetBtn"   class="mode-btn pet"><span class="dot"></span>Lost Pet</button>
          <button id="modeItemBtn"  class="mode-btn item"><span class="dot"></span>Lost Item</button>
          <button id="modeDangerBtn" class="mode-btn dang"><span class="dot"></span>Danger</button>
        </div>
        <div class="time-filter" id="timeFilter">
          <button data-hours="24">Last 24h</button>
          <button data-hours="168">This week</button>
          <button data-hours="720">This month</button>
          <button data-hours="0" class="active">All time</button>
        </div>
        <div class="notif-row">
          <button id="notifToggle" class="notif-toggle" title="Get alerts for new pins nearby">ğŸ”” Alerts: Off</button>
          <select id="notifRadius" style="font-size:12px;padding:4px;background:var(--panel);color:var(--fg);border:1px solid var(--border);border-radius:6px">
            <option value="2">2 km</option>
            <option value="5" selected>5 km</option>
            <option value="10">10 km</option>
            <option value="25">25 km</option>
            <option value="50">50 km</option>
            <option value="0">Any distance</option>
          </select>
        </div>
      </div>
      <ul id="locationList"></ul>
    </aside>

    <!-- Mobile top bar -->
    <div id="topbar">
      <div>
        <div class="title">Lost Pins</div>
        <div id="whoamiTop" class="who"></div>
      </div>
      <button id="logoutBtnTop">Sign out</button>
    </div>

    <!-- Mobile bottom controls (always visible) -->
    <div id="bottomBar" aria-label="Controls">
      <div class="mode-strip">
        <button id="modeCatBtn_m"   class="mode-btn cat"><span class="dot"></span>Lost Cat</button>
        <button id="modeDogBtn_m"   class="mode-btn dog"><span class="dot"></span>Lost Dog</button>
        <button id="modePetBtn_m"   class="mode-btn pet"><span class="dot"></span>Lost Pet</button>
        <button id="modeItemBtn_m"  class="mode-btn item"><span class="dot"></span>Lost Item</button>
        <button id="modeDangerBtn_m" class="mode-btn dang"><span class="dot"></span>Danger</button>
      </div>
      <div class="action-row">
        <button id="searchBtn_m" title="Find place">Search</button>
        <button id="locateBtn_m" title="Center on my location">Locate me</button>
        <button id="deleteAllBtn_m" class="danger">Delete All Pins (mine)</button>
        <button id="openUsersBtn_m" style="display:none">Users</button>
      </div>
    </div>

    <!-- Map -->
    <main style="position:relative">
      <div id="map"></div>
      <div id="pinHint" class="pin-hint" style="display:none">Tap the map to place a pin</div>
    </main>
  </div>

  <!-- Users (moderation) modal -->
  <div id="usersModal" class="modal-backdrop" hidden>
    <div class="modal">
      <h3>Users</h3>
      <div class="terms-body" style="max-height:60vh">
        <ul id="userList" style="list-style:none;margin:0;padding:0"></ul>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button id="closeUsersBtn">Close</button>
      </div>
    </div>
  </div>

  <!-- Terms & Consent Modal -->
  <div id="termsModal" class="modal-backdrop" hidden>
    <div class="modal">
      <h3 id="termsTitle">Terms &amp; Consent</h3>
      <div id="termsNote" class="muted" style="margin:6px 0 8px 0;">Please read carefully.</div>
      <div class="terms-body" id="termsBody" aria-label="Terms">
        <p><strong>Purpose.</strong> Lost Pins is a community tool to help locate missing pets/items and flag hazards . We process your <em>Google email</em> and the content you submit (pins, descriptions, photos).</p>
        <p><strong>Lawful basis (consent) &amp; transparency.</strong> By agreeing, you consent to processing your personal data for the purposes above. You are informed of what we collect, why, and how we use it, consistent with the Personal Data Protection Law of the Kingdom of Saudi Arabia (PDPL) and its Implementing Regulations. You may withdraw consent at any time (see â€œYour rightsâ€).</p>
        <p><strong>What we collect.</strong> (1) Google email (required); (2) userâ€‘generated content: pin type, location, title, description, optional photo; (3) service/hosting metadata (e.g., IP/device info) collected by Firebase/Google Cloud for security and reliability.</p>
        <p><strong>Use &amp; sharing.</strong> We show pins on the map; moderators may review content for safety and policy compliance. We do not sell personal data. We share data only as necessary with hosting providers or if required by law.</p>
        <p><strong>Crossâ€‘border transfer.</strong> Firebase/Google Cloud may store/process data outside KSA. By agreeing, you consent to such transfers as permitted under the PDPL and its regulations on transfers outside the Kingdom.</p>
        <p><strong>Retention.</strong> We keep data while the service is active and you have an account. We may purge pins older than needed or after 12 months of inactivity. You can delete your pins at any time; you may also request account deletion.</p>
        <p><strong>Your rights.</strong> Under PDPL, you can request access to, correction of, or deletion of your personal data and may withdraw consent. Contact <a href="mailto:lenatif09@gmail.com">lenatif09@gmail.com</a> to exercise your rights.</p>
        <p><strong>Age &amp; conduct.</strong> This service is for adults. Do not post illegal, harmful, or unlawful content; do not fundraise or solicit money; do not post personal data of others without permission. We may remove content and suspend accounts for violations.</p>
        <p><strong>Security &amp; breaches.</strong> We use reasonable technical and organizational measures. If a personalâ€‘data incident occurs, we will follow applicable PDPL guidance and notify where required.</p>
        <p><strong>Contact.</strong> Controller: Lost Pins (community project). Email: <a href="mailto:lenatif09@gmail.com">lenatif09@gmail.com</a>. Governing law: Kingdom of Saudi Arabia. We may update these terms; we will ask you to reâ€‘consent to material changes.</p>
      </div>
      <div class="row" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="closeTermsBtn">Cancel</button>
        <button id="agreeTermsBtn" class="primary">I Agree</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Pin Modal -->
  <div id="pinModal" class="modal-backdrop" hidden>
    <div class="modal">
      <h3 id="modalTitle">New location</h3>
      <div class="f">
        <div>
          <label for="titleInput">Title</label>
          <input id="titleInput" type="text" placeholder="Name" />
        </div>
        <div>
          <label for="coordsInput">Coordinates</label>
          <input id="coordsInput" type="text" readonly />
        </div>
        <div>
          <label>Pin type</label>
          <div class="type-group" id="typeGroup">
            <label class="type-pill"><input type="radio" name="pinType" value="lostcat" checked /> <span class="dot cat"></span> Lost Cat</label>
            <label class="type-pill"><input type="radio" name="pinType" value="lostdog" /> <span class="dot dog"></span> Lost Dog</label>
            <label class="type-pill"><input type="radio" name="pinType" value="lostpet" /> <span class="dot pet"></span> Lost Pet</label>
            <label class="type-pill"><input type="radio" name="pinType" value="lostitem" /> <span class="dot item"></span> Lost Item</label>
            <label class="type-pill"><input type="radio" name="pinType" value="danger" /> <span class="dot danger"></span> Danger</label>
          </div>
          <div id="typePreview" class="mini-note"></div>
        </div>
        <div>
          <label>Photo (optional)</label>
          <div class="row" style="gap:6px">
            <label class="btn" for="photoInput">Upload photo</label>
            <input id="photoInput" type="file" accept="image/*" />
            <button id="removePhotoBtn" class="danger" style="display:none">Remove photo</button>
          </div>
        </div>
        <img id="photoPreview" class="photo-prev" alt="Preview" />
        <div style="grid-column:1/-1">
          <label for="descInput">Description</label>
          <textarea id="descInput" placeholder="Notes, directions, etc."></textarea>
        </div>
        <div>
          <label for="contactInput">Contact (phone/WhatsApp)</label>
          <input id="contactInput" type="text" placeholder="+966 5x xxx xxxx" />
        </div>
        <div>
          <label for="rewardInput">Reward (optional)</label>
          <input id="rewardInput" type="text" placeholder="e.g. 500 SAR" />
        </div>
        <div class="mini-note">Photos are auto-cropped to square and compressed.</div>
      </div>
      <div class="row">
        <button id="cancelBtn">Cancel</button>
        <button id="saveBtn" class="primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Language Toggle -->
  <button id="themeToggle" class="theme-toggle" title="Toggle dark mode">ğŸŒ™</button>
  <button id="langToggle" class="lang-toggle">Ø¹Ø±Ø¨ÙŠ</button>

  <!-- Sighting Modal -->
  <div id="sightingModal" class="modal-backdrop" hidden>
    <div class="modal">
      <h3>Report a Sighting</h3>
      <div class="f">
        <div style="grid-column:1/-1">
          <label for="sightingNote">What did you see?</label>
          <textarea id="sightingNote" placeholder="e.g. Saw a cat matching description near the park fountain, heading east"></textarea>
        </div>
        <div class="mini-note">Your current location will be recorded. This helps build a sighting trail on the map.</div>
      </div>
      <div class="row" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="cancelSightingBtn">Cancel</button>
        <button id="saveSightingBtn" class="primary">Submit Sighting</button>
      </div>
    </div>
  </div>

  <!-- In-app browser warning -->
  <div id="inAppWarning">
    Google sign-in may not work inside this appâ€™s browser.
    <button id="openSystemBtn" style="margin-left:8px">Open in Safari/Chrome</button>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    /* ---------- Firebase SDKs ---------- */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
    import {
      initializeAuth,
      indexedDBLocalPersistence,
      browserLocalPersistence,
      browserSessionPersistence,
      inMemoryPersistence,
      browserPopupRedirectResolver,
      onAuthStateChanged,
      signOut,
      GoogleAuthProvider,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult
    } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js';
    import {
      getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc,
      onSnapshot, query, orderBy, where, writeBatch, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';

    /* ---------- Config ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyCVxRVywtfJIV6G55r1se3BoYVjtHxWDFM",
      authDomain: "fat-fat-cat.firebaseapp.com",
      projectId: "fat-fat-cat",
      storageBucket: "fat-fat-cat.firebasestorage.app",
      messagingSenderId: "409243971382",
      appId: "1:409243971382:web:646a6858479a9740d04d97"
    };
    const appFB = initializeApp(firebaseConfig);
    const auth = initializeAuth(appFB, {
      persistence: [
        indexedDBLocalPersistence,
        browserLocalPersistence,
        browserSessionPersistence,
        inMemoryPersistence
      ],
      popupRedirectResolver: browserPopupRedirectResolver
    });
    const db = getFirestore(appFB);

    /* ---------- Owner/domain gate ---------- */
    const OWNER_EMAIL = 'lenatif09@gmail.com';
    const isAllowedEmail = (email) => {
      return !!(email && email.trim());
    };

    /* ---------- Terms ---------- */
    const TERMS_VERSION='v2-2025-08-24';
    const CONSENT_STASH_KEY='kaustpins.preconsent.v1';

    /* ---------- DOM ---------- */
    const $=(id)=>document.getElementById(id);
    const gate=$('gate'), gateError=$('gateError'), googleBtn=$('googleBtn'), openTermsLink=$('openTermsLink');
    const termsModal=$('termsModal'), agreeTermsBtn=$('agreeTermsBtn'), closeTermsBtn=$('closeTermsBtn');

    const whoami=$('whoami'), logoutBtn=$('logoutBtn');
    const whoamiTop=$('whoamiTop'), logoutBtnTop=$('logoutBtnTop');

    const bottomBar=$('bottomBar');
    const openUsersBtn=$('openUsersBtn'), openUsersBtn_m=$('openUsersBtn_m');
    const usersModal=$('usersModal'), closeUsersBtn=$('closeUsersBtn'), userList=$('userList');

    const searchInput=$('searchInput'), searchBtn=$('searchBtn'), searchBtn_m=$('searchBtn_m');
    const locateBtn=$('locateBtn'), locateBtn_m=$('locateBtn_m');
    const deleteAllBtn=$('deleteAllBtn'), deleteAllBtn_m=$('deleteAllBtn_m');

    const modeCatBtn=$('modeCatBtn'),   modeDogBtn=$('modeDogBtn'),   modePetBtn=$('modePetBtn'),   modeItemBtn=$('modeItemBtn'),   modeDangerBtn=$('modeDangerBtn');
    const modeCatBtn_m=$('modeCatBtn_m'),modeDogBtn_m=$('modeDogBtn_m'),modePetBtn_m=$('modePetBtn_m'),modeItemBtn_m=$('modeItemBtn_m'),modeDangerBtn_m=$('modeDangerBtn_m');

    const pinModal=$('pinModal'), modalTitle=$('modalTitle'),
      titleInput=$('titleInput'), descInput=$('descInput'), coordsInput=$('coordsInput'),
      photoInput=$('photoInput'), photoPreview=$('photoPreview'), removePhotoBtn=$('removePhotoBtn'),
      cancelBtn=$('cancelBtn'), saveBtn=$('saveBtn'), typeGroup=$('typeGroup'), typePreview=$('typePreview');
    const contactInput=$('contactInput'), rewardInput=$('rewardInput');
    const sightingModal=$('sightingModal'), sightingNote=$('sightingNote'),
      cancelSightingBtn=$('cancelSightingBtn'), saveSightingBtn=$('saveSightingBtn');
    const timeFilter=$('timeFilter');
    const profileRow=$('profileRow'), profileAvatar=$('profileAvatar'),
      profileName=$('profileName'), profileEmail=$('profileEmail'),
      changeAvatarBtn=$('changeAvatarBtn'), avatarInput=$('avatarInput');

    const pinHint=$('pinHint');

    /* ---------- Inâ€‘app browser warning ---------- */
    const IN_APP=/FBAN|FBAV|Instagram|Line\/|Twitter|LinkedInApp|Snapchat|Pinterest|WeChat|MiuiBrowser|WhatsApp/i.test(navigator.userAgent);
    const inAppBar=$('inAppWarning'), openSystemBtn=$('openSystemBtn');
    if(IN_APP){
      inAppBar.style.display='block';
      openSystemBtn.onclick=()=>{ window.open(location.href,'_blank','noopener,noreferrer'); alert('If a new tab didnâ€™t open, use the â€¢â€¢â€¢ menu â†’ â€œOpen in browserâ€.'); };
    }

    /* ---------- Map ---------- */
    const VIEW_KEY='pinboard.mapview.v5';
    const savedView=JSON.parse(localStorage.getItem(VIEW_KEY)||"null");
    const map=L.map('map',{center:savedView?[savedView.lat,savedView.lng]:[20,0],zoom:savedView?Math.max(1,Math.min(19,savedView.zoom|0)):2,worldCopyJump:true});
    let currentTiles=L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap &copy; CARTO',subdomains:'abcd'}).addTo(map);
    const TILE_LIGHT='https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
    const TILE_DARK='https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
    map.on('moveend',()=>{const c=map.getCenter();localStorage.setItem(VIEW_KEY,JSON.stringify({lat:c.lat,lng:c.lng,zoom:map.getZoom()}));});

    /* Auto-locate on first visit (no saved view) */
    if(!savedView && navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        (pos)=>{ map.flyTo([pos.coords.latitude,pos.coords.longitude],14,{duration:1.2}); },
        ()=>{/* denied or error â€” stay at world view */},
        {enableHighAccuracy:true,timeout:10000,maximumAge:300000}
      );
    }

    /* ---------- Types & helpers ---------- */
    const TYPES=['lostcat','lostdog','lostpet','lostitem','danger'];
    const TYPE_LABEL={lostcat:'Lost Cat',lostdog:'Lost Dog',lostpet:'Lost Pet',lostitem:'Lost Item',danger:'Danger'};
    const glyphForType=(t)=>t==='danger'?'âš ï¸':t==='lostdog'?'ğŸ¶':t==='lostpet'?'ğŸ¾':t==='lostitem'?'â“':'ğŸ±';
    const typeName=(tp)=>{ const m={lostcat:'lostCat',lostdog:'lostDog',lostpet:'lostPet',lostitem:'lostItem',danger:'danger'}; return m[tp]?t(m[tp]):(TYPE_LABEL[tp]||'Unknown'); };
    const typeClass=(t)=>({lostcat:'cat',lostdog:'dog',lostpet:'pet',lostitem:'item',danger:'danger'}[t]||'cat');
    const SLOT_IDS=['s1','s2','s3','s4','s5'];
    const fmt=(n)=>Number(n).toFixed(6);
    const fmtLatLng=(loc)=>`${fmt(loc.lat)}, ${fmt(loc.lng)}`;
    const escapeHtml=(s)=>String(s).replace(/[&<>"']/g,(m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    const statusLabel = (s) => s==='found' ? t('statusFound') : s==='lost' ? t('statusLost') : t('statusOpen');
    const statusClass = (s) => s==='found' ? 'status-found' : s==='lost' ? 'status-lost' : 'status-open';

    /* ---------- State ---------- */
    const state={activeType:null,markers:new Map(),locations:[],draftLatLng:null,draftPhoto:null,editingId:null,saving:false,pendingPinId:null,isAdmin:false,isMod:false,isBanned:false,users:[],hbTimer:null,filterHours:0,sightingPinId:null,lang:'en'};

    /* ---------- i18n ---------- */
    const i18n={
      en:{
        appTitle:'Lost Pins',signIn:'Sign in with Google to continue',signOut:'Sign out',
        search:'Search a place (e.g., Jeddah, London)',searchBtn:'Search',locateMe:'Locate me',
        deleteAll:'Delete All Pins (mine)',users:'Users',
        lostCat:'Lost Cat',lostDog:'Lost Dog',lostPet:'Lost Pet',lostItem:'Lost Item',danger:'Danger',
        last24h:'Last 24h',thisWeek:'This week',thisMonth:'This month',allTime:'All time',
        newLocation:'New location',editLocation:'Edit location',title:'Title',coordinates:'Coordinates',
        pinType:'Pin type',photo:'Photo (optional)',uploadPhoto:'Upload photo',removePhoto:'Remove photo',
        description:'Description',descPlaceholder:'Notes, directions, etc.',
        contact:'Contact (phone/WhatsApp)',contactPlaceholder:'+966 5x xxx xxxx',
        reward:'Reward (optional)',rewardPlaceholder:'e.g. 500 SAR',
        cancel:'Cancel',save:'Save',saving:'Savingâ€¦',
        noLocations:'No locations yet. Pick a type, then tap the map.',
        miniNote:'Photos are auto-cropped to square and compressed.',
        sightingTitle:'Report a Sighting',sightingPlaceholder:'e.g. Saw a cat matching description near the park fountain',
        sightingNote:'Your current location will be recorded.',submitSighting:'Submit Sighting',
        shareWA:'ğŸ“¤ WhatsApp',shareTweet:'ğŸ¦ Tweet',copyLink:'ğŸ”— Copy Link',
        spotted:'ğŸ‘ï¸ I Spotted This',printFlyer:'ğŸ–¨ï¸ Print Flyer',
        markFound:'Mark Found',markLost:'Mark Lost',reopen:'Reopen',edit:'Edit',delete:'Delete',
        view:'View',share:'ğŸ“¤ Share',copied:'âœ“ Copied!',
        sightings:'sighting',sightingsPlural:'sightings',noSightings:'No sightings yet',
        loginTitle:'Lost Pins',loginSubtitle:'Sign in with Google to continue',
        langToggle:'Ø¹Ø±Ø¨ÙŠ',termsTitle:'Terms & Consent',
        statusOpen:'Open',statusFound:'Found',statusLost:'Lost'
      },
      ar:{
        appTitle:'Ø¯Ø¨Ø§Ø¨ÙŠØ³ Ù…ÙÙ‚ÙˆØ¯Ø©',signIn:'Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ø­Ø³Ø§Ø¨ Google Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©',signOut:'ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬',
        search:'Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù† (Ù…Ø«Ù„Ø§Ù‹: Ø¬Ø¯Ø©ØŒ Ø§Ù„Ø±ÙŠØ§Ø¶)',searchBtn:'Ø¨Ø­Ø«',locateMe:'Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ÙŠ',
        deleteAll:'Ø­Ø°Ù ÙƒÙ„ Ø¯Ø¨Ø§Ø¨ÙŠØ³ÙŠ',users:'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†',
        lostCat:'Ù‚Ø·Ø© Ù…ÙÙ‚ÙˆØ¯Ø©',lostDog:'ÙƒÙ„Ø¨ Ù…ÙÙ‚ÙˆØ¯',lostPet:'Ø­ÙŠÙˆØ§Ù† Ù…ÙÙ‚ÙˆØ¯',lostItem:'ØºØ±Ø¶ Ù…ÙÙ‚ÙˆØ¯',danger:'Ø®Ø·Ø±',
        last24h:'Ø¢Ø®Ø± Ù¢Ù¤ Ø³Ø§Ø¹Ø©',thisWeek:'Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹',thisMonth:'Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±',allTime:'ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª',
        newLocation:'Ù…ÙˆÙ‚Ø¹ Ø¬Ø¯ÙŠØ¯',editLocation:'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹',title:'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†',coordinates:'Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª',
        pinType:'Ù†ÙˆØ¹ Ø§Ù„Ø¯Ø¨ÙˆØ³',photo:'ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',uploadPhoto:'Ø±ÙØ¹ ØµÙˆØ±Ø©',removePhoto:'Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©',
        description:'Ø§Ù„ÙˆØµÙ',descPlaceholder:'Ù…Ù„Ø§Ø­Ø¸Ø§ØªØŒ Ø§ØªØ¬Ø§Ù‡Ø§ØªØŒ Ø¥Ù„Ø®.',
        contact:'Ø§Ù„ØªÙˆØ§ØµÙ„ (Ù‡Ø§ØªÙ/ÙˆØ§ØªØ³Ø§Ø¨)',contactPlaceholder:'+966 5x xxx xxxx',
        reward:'Ù…ÙƒØ§ÙØ£Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',rewardPlaceholder:'Ù…Ø«Ù„Ø§Ù‹: Ù¥Ù Ù  Ø±ÙŠØ§Ù„',
        cancel:'Ø¥Ù„ØºØ§Ø¡',save:'Ø­ÙØ¸',saving:'Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸â€¦',
        noLocations:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ù‚Ø¹ Ø¨Ø¹Ø¯. Ø§Ø®ØªØ± Ù†ÙˆØ¹Ø§Ù‹ Ø«Ù… Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.',
        miniNote:'ÙŠØªÙ… Ù‚Øµ Ø§Ù„ØµÙˆØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆØ¶ØºØ·Ù‡Ø§.',
        sightingTitle:'Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´Ø§Ù‡Ø¯Ø©',sightingPlaceholder:'Ù…Ø«Ù„Ø§Ù‹: Ø´Ø§Ù‡Ø¯Øª Ù‚Ø·Ø© Ù…Ø´Ø§Ø¨Ù‡Ø© Ù„Ù„ÙˆØµÙ Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ù†Ø§ÙÙˆØ±Ø© Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø©',
        sightingNote:'Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ.',submitSighting:'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©',
        shareWA:'ğŸ“¤ ÙˆØ§ØªØ³Ø§Ø¨',shareTweet:'ğŸ¦ ØªØºØ±ÙŠØ¯Ø©',copyLink:'ğŸ”— Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·',
        spotted:'ğŸ‘ï¸ Ø´Ø§Ù‡Ø¯Øª Ù‡Ø°Ø§',printFlyer:'ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ù…Ù†Ø´ÙˆØ±',
        markFound:'ÙˆÙØ¬Ø¯',markLost:'Ù…ÙÙ‚ÙˆØ¯',reopen:'Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­',edit:'ØªØ¹Ø¯ÙŠÙ„',delete:'Ø­Ø°Ù',
        view:'Ø¹Ø±Ø¶',share:'ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©',copied:'âœ“ ØªÙ… Ø§Ù„Ù†Ø³Ø®!',
        sightings:'Ù…Ø´Ø§Ù‡Ø¯Ø©',sightingsPlural:'Ù…Ø´Ø§Ù‡Ø¯Ø§Øª',noSightings:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ù‡Ø¯Ø§Øª Ø¨Ø¹Ø¯',
        loginTitle:'Ø¯Ø¨Ø§Ø¨ÙŠØ³ Ù…ÙÙ‚ÙˆØ¯Ø©',loginSubtitle:'Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ø­Ø³Ø§Ø¨ Google Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©',
        langToggle:'English',termsTitle:'Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ù…ÙˆØ§ÙÙ‚Ø©',
        statusOpen:'Ù…ÙØªÙˆØ­',statusFound:'ÙˆÙØ¬Ø¯',statusLost:'Ù…ÙÙ‚ÙˆØ¯'
      }
    };
    function t(key){ return i18n[state.lang]?.[key]||i18n.en[key]||key; }
    function applyLang(){
      const lang=state.lang; const isRtl=lang==='ar';
      document.documentElement.dir=isRtl?'rtl':'ltr';
      document.documentElement.lang=lang;
      // Toggle button
      const langBtn=$('langToggle'); if(langBtn) langBtn.textContent=t('langToggle');
      // Header
      const titleEl=document.querySelector('.title'); if(titleEl) titleEl.textContent=t('appTitle');
      // Login screen
      const loginTitle=document.querySelector('#loginScreen h2'); if(loginTitle) loginTitle.textContent=t('loginTitle');
      const loginSub=document.querySelector('#loginScreen p'); if(loginSub) loginSub.textContent=t('loginSubtitle');
      const loginBtn=document.querySelector('#googleBtn'); if(loginBtn) loginBtn.textContent=t('signIn');
      // Sidebar controls
      const si=$('searchInput'); if(si) si.placeholder=t('search');
      const sb=$('searchBtn'); if(sb) sb.textContent=t('searchBtn');
      const lb=$('locateBtn'); if(lb) lb.textContent=t('locateMe');
      const da=$('deleteAllBtn'); if(da) da.textContent=t('deleteAll');
      const ub=$('openUsersBtn'); if(ub) ub.textContent=t('users');
      const lo=$('logoutBtn'); if(lo) lo.textContent=t('signOut');
      // Mode buttons
      const modes=[['modeCatBtn','lostCat'],['modeDogBtn','lostDog'],['modePetBtn','lostPet'],['modeItemBtn','lostItem'],['modeDangerBtn','danger']];
      modes.forEach(([id,key])=>{ const b=$(id); if(b){ const dot=b.querySelector('.dot'); b.textContent=''; if(dot)b.appendChild(dot); b.append(t(key)); }});
      // Time filter
      const tfBtns=timeFilter?.querySelectorAll('button');
      if(tfBtns){ const keys=['last24h','thisWeek','thisMonth','allTime']; tfBtns.forEach((b,i)=>{ if(keys[i]) b.textContent=t(keys[i]); }); }
      // Pin modal
      const labels={'titleInput':t('title'),'coordsInput':t('coordinates'),'descInput':t('description'),'contactInput':t('contact'),'rewardInput':t('reward')};
      Object.entries(labels).forEach(([id,lbl])=>{ const el=$(id); if(el){ const label=el.previousElementSibling||el.closest('div')?.querySelector('label'); if(label&&label.tagName==='LABEL') label.textContent=lbl; }});
      const di=$('descInput'); if(di) di.placeholder=t('descPlaceholder');
      const ci=$('contactInput'); if(ci) ci.placeholder=t('contactPlaceholder');
      const ri=$('rewardInput'); if(ri) ri.placeholder=t('rewardPlaceholder');
      cancelBtn.textContent=t('cancel'); saveBtn.textContent=state.saving?t('saving'):t('save');
      // Sighting modal
      const st=document.querySelector('#sightingModal h3'); if(st) st.textContent=t('sightingTitle');
      if(sightingNote) sightingNote.placeholder=t('sightingPlaceholder');
      cancelSightingBtn.textContent=t('cancel');
      saveSightingBtn.textContent=t('submitSighting');
      // Re-render list
      renderList();
    }
    // Lang toggle
    const langToggle=$('langToggle');
    if(langToggle) langToggle.onclick=()=>{
      state.lang=state.lang==='en'?'ar':'en';
      localStorage.setItem('lostpins_lang',state.lang);
      applyLang();
    };
    // Restore saved lang
    const savedLang=localStorage.getItem('lostpins_lang');
    if(savedLang&&i18n[savedLang]) state.lang=savedLang;
    applyLang();

    /* ---------- Theme toggle ---------- */
    const themeToggle=$('themeToggle');
    function applyTheme(theme){
      document.documentElement.setAttribute('data-theme',theme);
      if(themeToggle) themeToggle.textContent=theme==='dark'?'â˜€ï¸':'ğŸŒ™';
      if(themeToggle) themeToggle.title=theme==='dark'?'Switch to light mode':'Switch to dark mode';
      // Swap map tiles
      const url=theme==='dark'?TILE_DARK:TILE_LIGHT;
      if(currentTiles) map.removeLayer(currentTiles);
      currentTiles=L.tileLayer(url,{maxZoom:19,attribution:'&copy; OpenStreetMap &copy; CARTO',subdomains:'abcd'}).addTo(map);
    }
    // Restore saved theme
    const savedTheme=localStorage.getItem('lostpins_theme')||(window.matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light');
    applyTheme(savedTheme);
    if(themeToggle) themeToggle.onclick=()=>{
      const next=document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';
      localStorage.setItem('lostpins_theme',next);
      applyTheme(next);
    };

    /* ---------- Avatars ---------- */
    let myAvatarB64=null; // current user's avatar as small base64

    function avatarHtml(src,name,cls='avatar'){
      if(src) return `<img class="${cls}" src="${src}" alt="">`;
      const initial=(name||'?').charAt(0).toUpperCase();
      const sizeClass=cls.includes('sm')?'sm':'';
      return `<span class="${cls} avatar-placeholder ${sizeClass}">${initial}</span>`;
    }

    async function urlToBase64(url,size=64){
      return new Promise((resolve)=>{
        const img=new Image();
        img.crossOrigin='anonymous';
        img.onload=()=>{
          const c=document.createElement('canvas'); c.width=size; c.height=size;
          const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,size,size);
          resolve(c.toDataURL('image/jpeg',0.8));
        };
        img.onerror=()=>resolve(null);
        img.src=url;
      });
    }

    async function processAvatarFile(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=(e)=>{
          const img=new Image();
          img.onload=()=>{
            const c=document.createElement('canvas'); c.width=64; c.height=64;
            const ctx=c.getContext('2d');
            const s=Math.min(img.width,img.height);
            const sx=(img.width-s)/2, sy=(img.height-s)/2;
            ctx.drawImage(img,sx,sy,s,s,0,0,64,64);
            resolve(c.toDataURL('image/jpeg',0.8));
          };
          img.onerror=()=>reject(new Error('Invalid image'));
          img.src=e.target.result;
        };
        reader.onerror=()=>reject(new Error('Read failed'));
        reader.readAsDataURL(file);
      });
    }

    function updateProfileUI(user,avatarSrc){
      if(!profileRow) return;
      profileRow.style.display='flex';
      profileName.textContent=user.displayName||user.email?.split('@')[0]||'';
      profileEmail.textContent=user.email||'';
      if(avatarSrc){
        profileAvatar.src=avatarSrc; profileAvatar.style.display='';
      } else {
        profileAvatar.src=''; profileAvatar.style.display='none';
      }
    }

    // Avatar upload handlers
    if(changeAvatarBtn) changeAvatarBtn.onclick=()=>avatarInput?.click();
    if(profileAvatar) profileAvatar.onclick=()=>avatarInput?.click();
    if(avatarInput) avatarInput.onchange=async(e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      try{
        const b64=await processAvatarFile(f);
        myAvatarB64=b64;
        const user=auth.currentUser; if(!user) return;
        await updateDoc(doc(db,'users',user.uid),{avatarB64:b64});
        updateProfileUI(user,b64);
        // Update existing pins with new avatar
        const myPins=state.locations.filter(p=>p.ownerUid===user.uid);
        for(const p of myPins){
          try{ await updateDoc(doc(db,'pins',p.id),{ownerAvatar:b64}); }catch{}
        }
      }catch(err){ alert('Could not process image: '+err.message); }
      avatarInput.value='';
    };

    const clampZoom=(z)=>Math.max(1,Math.min(19,z|0));

    /* ---------- Search & locate ---------- */
    if(searchInput){ searchInput.onkeydown=(e)=>{ if(e.key==='Enter') runSearch(); }; }
    if(searchBtn){ searchBtn.onclick=runSearch; }
    if(searchBtn_m){ searchBtn_m.onclick=runSearch; }
    async function runSearch(){
      let q='';
      if(searchInput){ q=searchInput.value.trim(); }
      if(!q){ q=prompt('Search a place (e.g., KAUST, Jeddah):','')||''; q=q.trim(); if(searchInput) searchInput.value=q; }
      if(!q) return;
      (searchBtn||searchBtn_m).disabled=true; (searchBtn||searchBtn_m).textContent='Searchingâ€¦';
      try{
        const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`,{headers:{'Accept':'application/json'}});
        const data=await res.json();
        if(Array.isArray(data)&&data.length){ const r=data[0]; map.flyTo([parseFloat(r.lat),parseFloat(r.lon)],14,{duration:0.7}); }
        else alert('No results found.');
      }catch{ alert('Search error.'); }
      finally{ (searchBtn||searchBtn_m).disabled=false; (searchBtn||searchBtn_m).textContent='Search'; }
    }
    function onLocate(btn){
      if(!navigator.geolocation) return alert('Geolocation not supported.');
      btn.disabled=true; btn.textContent='Locatingâ€¦';
      navigator.geolocation.getCurrentPosition((pos)=>{ map.flyTo([pos.coords.latitude,pos.coords.longitude],15,{duration:0.7}); btn.disabled=false; btn.textContent='Locate me'; },
        ()=>{ alert('Could not get your location.'); btn.disabled=false; btn.textContent='Locate me'; },
        {enableHighAccuracy:true,timeout:10000,maximumAge:60000});
    }
    if(locateBtn){ locateBtn.onclick=()=>onLocate(locateBtn); }
    if(locateBtn_m){ locateBtn_m.onclick=()=>onLocate(locateBtn_m); }

    /* ---------- Modes (desktop + mobile buttons in sync) ---------- */
    function setMode(type){
      if(state.isBanned && !state.isAdmin && !state.isMod){ alert('You are banned and cannot create pins.'); return; }
      state.activeType=(state.activeType===type)?null:type;
      localStorage.setItem('lostpins_mode',state.activeType||'');
      updateModeUI();
    }
    function updateModeUI(){
      const t=state.activeType;
      const sets=[
        [modeCatBtn,'lostcat'],[modeDogBtn,'lostdog'],[modePetBtn,'lostpet'],[modeItemBtn,'lostitem'],[modeDangerBtn,'danger'],
        [modeCatBtn_m,'lostcat'],[modeDogBtn_m,'lostdog'],[modePetBtn_m,'lostpet'],[modeItemBtn_m,'lostitem'],[modeDangerBtn_m,'danger']
      ];
      for(const [btn,typ] of sets){ if(!btn) continue; btn.classList.toggle('primary',t===typ); }
      pinHint.style.display = t ? 'block' : 'none';
      pinHint.textContent = t ? `Tap the map to place a ${typeName(t)} pin` : '';
    }
    const wireMode=(btn,type)=>{ if(btn) btn.onclick=()=>setMode(type); };
    wireMode(modeCatBtn,'lostcat'); wireMode(modeDogBtn,'lostdog'); wireMode(modePetBtn,'lostpet'); wireMode(modeItemBtn,'lostitem'); wireMode(modeDangerBtn,'danger');
    wireMode(modeCatBtn_m,'lostcat'); wireMode(modeDogBtn_m,'lostdog'); wireMode(modePetBtn_m,'lostpet'); wireMode(modeItemBtn_m,'lostitem'); wireMode(modeDangerBtn_m,'danger');

    /* ---------- Delete All Pins (mine) ---------- */
    async function deleteAllMine(){
      const user=auth.currentUser; if(!user) return;
      if(!confirm('Delete ALL pins you have created? This cannot be undone.')) return;
      try{
        const uid=user.uid;
        const qMine=query(collection(db,'pins'), where('ownerUid','==',uid));
        const snap=await getDocs(qMine);
        if(snap.empty){ alert('You have no pins.'); return; }
        let batch=writeBatch(db), ops=0, count=0;
        for(const d of snap.docs){
          const p=d.data();
          batch.delete(doc(db,'pins',d.id)); ops++; count++;
          if(p.type && p.slot){ batch.delete(doc(db,`users/${uid}/quota/${p.type}/slots/${p.slot}`)); ops++; }
          if(ops>=450){ await batch.commit(); batch=writeBatch(db); ops=0; }
        }
        if(ops>0) await batch.commit();
        alert(`Deleted ${count} pins.`);
      }catch(e){ alert(e?.message||'Failed to delete all pins.'); }
    }
    if(deleteAllBtn) deleteAllBtn.onclick=deleteAllMine;
    if(deleteAllBtn_m) deleteAllBtn_m.onclick=deleteAllMine;

    /* ---------- Map interactions ---------- */
    map.on('click',(e)=>{ if(state.activeType){ if(state.isBanned && !state.isAdmin && !state.isMod){ alert('You are banned and cannot create pins.'); return; } openCreateModal(e.latlng); } });

    /* ---------- Modal + image ---------- */
    function setPhotoPreview(dataUrl){
      state.draftPhoto=dataUrl||null;
      if(state.draftPhoto){ photoPreview.src=state.draftPhoto; photoPreview.style.display='block'; removePhotoBtn.style.display='inline-block'; }
      else { photoPreview.removeAttribute('src'); photoPreview.style.display='none'; removePhotoBtn.style.display='none'; photoInput.value=''; }
    }
    function openCreateModal(latlng){
      state.editingId=null; state.draftLatLng=latlng;
      state.pendingPinId=(self.crypto?.randomUUID?.()?self.crypto.randomUUID():(Date.now().toString(36)+Math.random().toString(36).slice(2)));
      setPhotoPreview(null); setSaving(false);
      modalTitle.textContent='New location';
      titleInput.value=''; descInput.value=''; coordsInput.value=`${fmt(latlng.lat)}, ${fmt(latlng.lng)}`;
      contactInput.value=''; rewardInput.value='';
      const t=state.activeType||'lostcat';
      const r=document.querySelector(`input[name="pinType"][value="${t}"]`); if(r) r.checked=true;
      typeGroup.style.display='none'; typePreview.textContent='Pin type: '+typeName(t);
      pinModal.hidden=false; setTimeout(()=>titleInput.focus(),0);
    }
    function openEditModal(id){
      const loc=state.locations.find(x=>x.id===id); if(!loc) return;
      if(!canEditLoc(loc)) return alert('You can edit only your own pins (or be mod/admin).');
      state.editingId=id; state.draftLatLng={lat:loc.lat,lng:loc.lng}; setPhotoPreview(loc.photo||null);
      modalTitle.textContent='Edit location'; titleInput.value=loc.title||''; descInput.value=loc.description||''; coordsInput.value=`${fmt(loc.lat)}, ${fmt(loc.lng)}`;
      contactInput.value=loc.contact||''; rewardInput.value=loc.reward||'';
      const r=document.querySelector(`input[name="pinType"][value="${loc.type}"]`); if(r) r.checked=true;
      if(state.isAdmin){ typeGroup.style.display='flex'; typePreview.textContent=''; }
      else { typeGroup.style.display='none'; typePreview.textContent='Pin type: '+typeName(loc.type); }
      pinModal.hidden=false; setTimeout(()=>titleInput.focus(),0);
    }
    function closePinModal(){ pinModal.hidden=true; state.editingId=null; state.draftLatLng=null; state.pendingPinId=null; setSaving(false); setPhotoPreview(null); typeGroup.style.display='none'; typePreview.textContent=''; }
    cancelBtn.onclick=closePinModal;
    pinModal.addEventListener('click',(e)=>{ if(e.target===pinModal) closePinModal(); });
    photoInput.onchange=async (e)=>{ const f=e.target.files?.[0]; if(!f) return; try{ const dataUrl=await processImage(f,256,'image/jpeg',0.85); setPhotoPreview(dataUrl); }catch{ alert('Could not read the image.'); } };
    removePhotoBtn.onclick=()=>setPhotoPreview(null);
    function processImage(file,size=256,mime='image/jpeg',q=0.85){
      return new Promise((resolve,reject)=>{
        const fr=new FileReader();
        fr.onload=()=>{ const img=new Image(); img.onload=()=>{
          const s=Math.min(img.width,img.height), sx=(img.width-s)/2, sy=(img.height-s)/2;
          const c=document.createElement('canvas'); c.width=c.height=size; const g=c.getContext('2d');
          g.drawImage(img,sx,sy,s,s,0,0,size,size); resolve(c.toDataURL(mime,q));
        }; img.onerror=()=>reject(new Error('img')); img.src=fr.result; }; fr.onerror=()=>reject(new Error('file')); fr.readAsDataURL(file);
      });
    }

    /* ---------- Quota helper ---------- */
    async function pickFreeSlot(uid,type){
      const snap=await getDocs(collection(db,`users/${uid}/quota/${type}/slots`));
      const used=new Set(); snap.forEach(d=>used.add(d.id));
      for(const s of SLOT_IDS){ if(!used.has(s)) return s; }
      return null;
    }

    /* ---------- CRUD & Resolve ---------- */
    async function createPin({id,title,description,type,lat,lng,photo,contact,reward}){
      const user=auth.currentUser; if(!user) return;
      const uid=user.uid; const email=(user.email||'').toLowerCase();
      const privileged=state.isAdmin||state.isMod;
      const pinId=id||doc(collection(db,'pins')).id;

      let slot=null; const batch=writeBatch(db);
      if(!privileged){
        slot=await pickFreeSlot(uid,type);
        if(!slot){ alert(`Limit reached: 5 ${typeName(type)} pins.`); return; }
        batch.set(doc(db,`users/${uid}/quota/${type}/slots/${slot}`),{pinId});
      }
      batch.set(doc(db,'pins',pinId),{
        title,description,type,lat,lng,photo:photo||null,
        contact:contact||null,reward:reward||null,
        ownerUid:uid,ownerEmail:email,ownerUsername:user.displayName||email.split('@')[0],
        ownerAvatar:myAvatarB64||null,
        status:'open',resolvedAt:null,resolvedBy:null,
        createdAt:serverTimestamp(),slot:slot||null
      });
      await batch.commit();
    }

    async function setPinStatus(id, next){
      const allowed=['open','found','lost'];
      if(!allowed.includes(next)) return;
      const u=auth.currentUser;
      const patch = next==='open'
        ? { status:'open', resolvedAt:null, resolvedBy:null }
        : { status:next, resolvedAt:serverTimestamp(), resolvedBy:(u?.email||null) };
      await updateDoc(doc(db,'pins',id), patch);
      if(next==='found'){ addXP(XP_VALUES.resolve,'Case resolved!'); }
    }

    async function updatePin(id,{title,description,lat,lng,photo,type,contact,reward}){
      const patch={title,description,lat,lng,photo:photo||null,contact:contact||null,reward:reward||null};
      if(state.isAdmin && type && TYPES.includes(type)) patch.type=type;
      await updateDoc(doc(db,'pins',id),patch);
    }

    function confirmDelete(id){ if(confirm('Delete this pin?')) deletePin(id); }
    async function deletePin(id){
      const snap=await getDoc(doc(db,'pins',id)); if(!snap.exists()) return;
      const p=snap.data(); const me=auth.currentUser;
      const can=(state.isAdmin||state.isMod||p.ownerUid===me?.uid)&&!(state.isBanned&&!state.isAdmin&&!state.isMod);
      if(!can) return alert('Not allowed.');
      const batch=writeBatch(db);
      batch.delete(doc(db,'pins',id));
      if(p.ownerUid && p.type && p.slot){ batch.delete(doc(db,`users/${p.ownerUid}/quota/${p.type}/slots/${p.slot}`)); }
      await batch.commit();
    }

    /* ---------- Save guard ---------- */
    function setSaving(on){
      state.saving=!!on; saveBtn.disabled=on; cancelBtn.disabled=on; photoInput.disabled=on;
      titleInput.readOnly=on; descInput.readOnly=on;
      if(on){ saveBtn.dataset._old=saveBtn.textContent; saveBtn.textContent='Savingâ€¦'; }
      else { saveBtn.textContent=saveBtn.dataset._old||'Save'; }
    }
    saveBtn.onclick=async ()=>{
      if(state.saving) return;
      if(state.isBanned && !state.isAdmin && !state.isMod){ alert('You are banned and cannot save pins.'); return; }
      setSaving(true);
      const title=titleInput.value.trim()||'(untitled)';
      const description=descInput.value.trim();
      const contact=contactInput.value.trim();
      const reward=rewardInput.value.trim();
      if(!state.draftLatLng){ closePinModal(); return; }
      try{
        if(state.editingId){
          let newType;
          if(state.isAdmin){
            const r=document.querySelector('input[name="pinType"]:checked')?.value;
            if(TYPES.includes(r)) newType=r;
          }
          await updatePin(state.editingId,{title,description,lat:state.draftLatLng.lat,lng:state.draftLatLng.lng,photo:state.draftPhoto,type:newType,contact,reward});
        }else{
          if(!state.activeType){ alert('Select a pin type first.'); setSaving(false); return; }
          await createPin({id:state.pendingPinId,title,description,type:state.activeType,lat:state.draftLatLng.lat,lng:state.draftLatLng.lng,photo:state.draftPhoto,contact,reward});
          addXP(XP_VALUES.pin,'New pin posted');
        }
        closePinModal();
      }catch(e){ alert(e?.message||'Save failed (rules/quota).'); setSaving(false); }
    };

    /* ---------- Markers & list ---------- */
    function clearMarkers(){ for(const id of Array.from(state.markers.keys())) removeMarker(id); state.locations=[]; renderList(); }
    function upsertLocalPin(p){ const i=state.locations.findIndex(x=>x.id===p.id); if(i===-1) state.locations.push(p); else state.locations[i]=p; upsertMarker(p); }
    function canEditLoc(loc){ const u=auth.currentUser; if(!u) return false; if(state.isAdmin||state.isMod) return true; return (loc.ownerUid===u.uid)&&!state.isBanned; }

    function markerPopupHtml(loc,canEdit){
      const img=loc.photo?`<img class="popup-img" src="${loc.photo}" alt="" style="width:100%;max-height:180px;object-fit:cover;border-radius:12px;margin-bottom:8px">`:'';
      const who=loc.ownerUsername||loc.ownerEmail?.split('@')[0]||'';
      const av=loc.ownerAvatar;
      const acts=[];
      if(canEdit){
        if(loc.status!=='found') acts.push(`<a href="#" data-action="found" data-id="${loc.id}">Mark Found</a>`);
        if(loc.status!=='lost') acts.push(`<a href="#" data-action="lost" data-id="${loc.id}">Mark Lost</a>`);
        if(loc.status && loc.status!=='open') acts.push(`<a href="#" data-action="reopen" data-id="${loc.id}">Reopen</a>`);
        acts.push(`<a href="#" data-action="edit" data-id="${loc.id}">Edit</a>`);
        acts.push(`<a href="#" data-action="delete" data-id="${loc.id}" style="color:#dc2626">Delete</a>`);
      }

      const contactHtml=loc.contact?`<div style="margin:6px 0"><a class="contact-pill" href="https://wa.me/${loc.contact.replace(/[^0-9+]/g,'')}" target="_blank" rel="noopener">ğŸ“± ${escapeHtml(loc.contact)}</a></div>`:'';
      const rewardHtml=loc.reward?`<div style="margin:4px 0"><span class="reward-badge">ğŸ’° Reward: ${escapeHtml(loc.reward)}</span></div>`:'';
      const shareUrl=`${location.origin}${location.pathname}?pin=${loc.id}`;
      const shareText=encodeURIComponent(`${loc.title} â€” Lost Pins\n${shareUrl}`);

      return `<div style="min-width:260px;max-width:320px">${img}
        <div style="font-weight:700;font-size:16px;margin-bottom:4px;color:var(--fg)">${escapeHtml(loc.title||'(untitled)')}</div>
        ${who?`<div style="font-size:12px;margin-bottom:6px;display:flex;align-items:center;gap:6px">${avatarHtml(av,who,'avatar-sm')}<span style="background:var(--blue-light);color:#1d4ed8;padding:3px 10px;border-radius:999px;border:1px solid #bfdbfe;font-size:12px;font-weight:600">${escapeHtml(who)}</span></div>`:''}
        <div style="color:var(--muted);font-size:12px;margin-bottom:8px">
          ${typeName(loc.type)} Â· <span class="status-pill ${statusClass(loc.status)}">${statusLabel(loc.status)}</span>
        </div>
        ${rewardHtml}${contactHtml}
        ${loc.description?`<div style="white-space:pre-wrap;margin-bottom:8px;font-size:13px">${escapeHtml(loc.description)}</div>`:''}
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px">
          <a class="popup-action share" href="https://wa.me/?text=${shareText}" target="_blank" rel="noopener">ğŸ“¤ WhatsApp</a>
          <a class="popup-action share" href="https://twitter.com/intent/tweet?text=${shareText}" target="_blank" rel="noopener">ğŸ¦ Tweet</a>
          <a class="popup-action share" href="#" data-action="copylink" data-url="${escapeHtml(shareUrl)}">ğŸ”— Copy Link</a>
          <a class="popup-action sight" href="#" data-action="sighting" data-id="${loc.id}">ğŸ‘ï¸ I Spotted This</a>
          <a class="popup-action flyer" href="#" data-action="flyer" data-id="${loc.id}">ğŸ–¨ï¸ Print Flyer</a>
        </div>
        <div id="sightings-${loc.id}" class="sightings-list"></div>
        ${acts.length?`<div style="display:flex;gap:8px;flex-wrap:wrap;border-top:1px solid var(--border);padding-top:8px;margin-top:6px">${acts.join(' ')}</div>`:''}
      </div>`;
    }
    function tooltipHtml(loc){
      const s=(loc.description||'').slice(0,140);
      const who=loc.ownerUsername||loc.ownerEmail?.split('@')[0]||'';
      return `<div class="tt">
        <div class="tt-title">${escapeHtml(loc.title||'(untitled)')}</div>
        <div class="tt-meta">${typeName(loc.type)} Â· ${statusLabel(loc.status)}${who?` Â· by ${escapeHtml(who)}`:''}</div>
        ${s?`<div class="tt-desc">${escapeHtml(s)}</div>`:''}
      </div>`;
    }
    function makeIcon(loc){
      const name=loc.ownerUsername||loc.ownerEmail?.split('@')[0]||'';
      const nameHtml=name?`<div class="pin-name">${escapeHtml(name.split(' ')[0])}</div>`:'';
      const html=`<div class="pin ${typeClass(loc.type)}"><div class="bubble">${loc.photo?`<img class="thumb" src="${loc.photo}" alt="">`:`<div class="glyph">${glyphForType(loc.type)}</div>`}</div><div class="stem"></div>${nameHtml}</div>`;
      return L.divIcon({className:'pin-icon',html,iconSize:[46,76],iconAnchor:[23,58],popupAnchor:[0,-56],tooltipAnchor:[0,-58]});
    }
    function addMarkerFor(loc){
      const m=L.marker([loc.lat,loc.lng],{draggable:canEditLoc(loc),icon:makeIcon(loc)});
      m.bindPopup(markerPopupHtml(loc,canEditLoc(loc)));
      m.bindTooltip(tooltipHtml(loc),{direction:'top',offset:[0,-54],className:'pin-tooltip',opacity:0.96});
      m.on('dragend',async (e)=>{ if(!canEditLoc(loc)) return; const {lat,lng}=e.target.getLatLng(); try{ await updateDoc(doc(db,'pins',loc.id),{lat,lng}); }catch{ alert('Update failed.'); }});
      m.on('popupopen',()=>{ const el=m.getPopup().getElement();
        el.querySelectorAll('a[data-action]').forEach(a=>{
          a.addEventListener('click', async (evt)=>{
            evt.preventDefault();
            const id=a.getAttribute('data-id'); const act=a.getAttribute('data-action');
            try{
              if(act==='edit') openEditModal(id);
              if(act==='delete') confirmDelete(id);
              if(act==='found') await setPinStatus(id,'found');
              if(act==='lost') await setPinStatus(id,'lost');
              if(act==='reopen') await setPinStatus(id,'open');
              if(act==='copylink'){ const url=a.getAttribute('data-url'); await navigator.clipboard?.writeText(url); a.textContent='âœ“ Copied!'; setTimeout(()=>{a.textContent='ğŸ”— Copy Link';},1500); }
              if(act==='sighting'){ state.sightingPinId=id; sightingNote.value=''; sightingModal.hidden=false; }
              if(act==='flyer'){ generateFlyer(id); }
            }catch(e){ alert(e?.message||'Update failed.'); }
          });
        });
        // Load sightings
        loadSightings(loc.id);
      });
      m.addTo(map); state.markers.set(loc.id,m);
    }
    function upsertMarker(loc){
      const m=state.markers.get(loc.id);
      if(!m) addMarkerFor(loc);
      else{
        m.setLatLng([loc.lat,loc.lng]); m.setIcon(makeIcon(loc));
        m.setPopupContent(markerPopupHtml(loc,canEditLoc(loc)));
        const tt=m.getTooltip(); if(tt) tt.setContent(tooltipHtml(loc));
        canEditLoc(loc)?m.dragging.enable():m.dragging.disable();
      }
    }
    function removeMarker(id){ const m=state.markers.get(id); if(m){ map.removeLayer(m); state.markers.delete(id);} }

    function renderList(){
      const list=$('locationList'); if(!list) return;
      list.innerHTML='';
      const filtered=state.locations.filter(loc=>isVisibleByFilter(loc));
      if(!filtered.length){
        const li=document.createElement('li'); li.className='loc';
        li.innerHTML='<div class="title-row"><div class="title-text" style="color:var(--muted)">No locations yet. Pick a type, then tap the map.</div></div>';
        list.appendChild(li); return;
      }
      const u=auth.currentUser;
      for(const loc of filtered){
        const li=document.createElement('li'); li.className='loc'; li.dataset.id=loc.id;

        // Title row
        const titleRow=document.createElement('div'); titleRow.className='title-row';
        const titleText=document.createElement('div'); titleText.className='title-text';
        const who=loc.ownerUsername||loc.ownerEmail?.split('@')[0]||'';
        const avSrc=loc.ownerAvatar||'';
        const avTag=avatarHtml(avSrc,who,'avatar-sm');
        const whoTag=(who?` <span class="who" style="margin-left:4px;color:var(--muted);font-size:12px">${escapeHtml(who)}</span>`:'');
        titleText.innerHTML = `<span style="display:inline-flex;align-items:center;gap:5px">${avTag}${escapeHtml(loc.title||'(untitled)')}${whoTag}</span>`;
        const typeBadge=document.createElement('span'); typeBadge.className=`badge ${typeClass(loc.type)}`; typeBadge.textContent=typeName(loc.type);
        const statusPill=document.createElement('span'); statusPill.className=`status-pill ${statusClass(loc.status)}`; statusPill.textContent=statusLabel(loc.status);
        titleRow.append(titleText, typeBadge, statusPill);

        // Actions row
        const actions=document.createElement('div'); actions.className='actions-row';
        const flyBtn=document.createElement('button'); flyBtn.textContent='View'; flyBtn.onclick=()=>{ map.flyTo([loc.lat,loc.lng],Math.max(map.getZoom(),15),{duration:0.7}); const m=state.markers.get(loc.id); if(m) m.openPopup(); };
        const shareBtn=document.createElement('button'); shareBtn.textContent='ğŸ“¤ Share'; shareBtn.onclick=()=>{
          const url=`${location.origin}${location.pathname}?pin=${loc.id}`;
          const text=`${loc.title} â€” Lost Pins\n${url}`;
          if(navigator.share){ navigator.share({title:loc.title,text,url}).catch(()=>{}); }
          else { navigator.clipboard?.writeText(text); shareBtn.textContent='âœ“ Copied!'; setTimeout(()=>{shareBtn.textContent='ğŸ“¤ Share';},1500); }
        };
        actions.append(flyBtn,shareBtn);
        if(canEditLoc(loc)){
          const editBtn=document.createElement('button'); editBtn.textContent='Edit'; editBtn.onclick=()=>openEditModal(loc.id);
          const delBtn=document.createElement('button'); delBtn.textContent='Delete'; delBtn.className='danger'; delBtn.onclick=()=>confirmDelete(loc.id);
          const foundBtn=document.createElement('button'); foundBtn.textContent='Mark Found'; foundBtn.onclick=async()=>{ try{ await setPinStatus(loc.id,'found'); }catch(e){ alert(e?.message||'Failed.'); } };
          const lostBtn=document.createElement('button'); lostBtn.textContent='Mark Lost'; lostBtn.onclick=async()=>{ try{ await setPinStatus(loc.id,'lost'); }catch(e){ alert(e?.message||'Failed.'); } };
          const reopenBtn=document.createElement('button'); reopenBtn.textContent='Reopen'; reopenBtn.onclick=async()=>{ try{ await setPinStatus(loc.id,'open'); }catch(e){ alert(e?.message||'Failed.'); } };

          // Only show the buttons that make sense for current status
          if(loc.status!=='found') actions.append(foundBtn);
          if(loc.status!=='lost') actions.append(lostBtn);
          if(loc.status && loc.status!=='open') actions.append(reopenBtn);
          actions.append(editBtn,delBtn);
        }

        // Meta row
        const meta=document.createElement('div'); meta.className='meta';
        let metaText=fmtLatLng(loc);
        if(loc.reward) metaText+=' Â· ğŸ’° '+loc.reward;
        if(loc.contact) metaText+=' Â· ğŸ“± '+loc.contact;
        meta.textContent=metaText;

        li.append(titleRow,actions,meta);
        list.appendChild(li);
      }
    }

    /* ---------- Feeds ---------- */
    /* ---------- Printable Flyer ---------- */
    function generateFlyer(pinId){
      const loc=state.locations.find(x=>x.id===pinId); if(!loc) return;
      const shareUrl=`${location.origin}${location.pathname}?pin=${loc.id}`;
      const qrUrl=`https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(shareUrl)}&bgcolor=ffffff&color=000000`;
      const typeLabel=typeName(loc.type);
      const statusColor=loc.status==='found'?'#2ecc71':loc.status==='lost'?'#e74c3c':'#f39c12';
      const bannerColor=loc.type==='danger'?'#e74c3c':loc.type==='lostcat'?'#7aa2f7':loc.type==='lostdog'?'#f7b955':loc.type==='lostpet'?'#3ac97a':'#bb9af7';
      const w=window.open('','_blank','width=800,height=1100');
      if(!w){ alert('Please allow popups to print flyers.'); return; }
      w.document.write(`<!DOCTYPE html><html><head><title>Lost Pins Flyer - ${escapeHtml(loc.title)}</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,sans-serif;background:#fff;color:#222;padding:40px;max-width:800px;margin:0 auto}
.banner{background:${bannerColor};color:#fff;text-align:center;padding:24px;border-radius:16px 16px 0 0;font-size:36px;font-weight:800;letter-spacing:2px;text-transform:uppercase}
.card{border:3px solid ${bannerColor};border-radius:16px;overflow:hidden;margin-bottom:20px}
.body{padding:24px;display:flex;gap:24px}
.photo{width:280px;height:280px;object-fit:cover;border-radius:12px;border:2px solid #eee;flex-shrink:0}
.no-photo{width:280px;height:280px;display:flex;align-items:center;justify-content:center;background:#f5f5f5;border-radius:12px;font-size:64px;flex-shrink:0}
.details{flex:1;display:flex;flex-direction:column;gap:12px}
.pet-name{font-size:28px;font-weight:700;color:#222}
.desc{font-size:15px;line-height:1.5;color:#444;white-space:pre-wrap}
.info-row{display:flex;gap:16px;flex-wrap:wrap}
.info-pill{background:#f0f0f0;padding:6px 14px;border-radius:999px;font-size:14px;font-weight:600}
.reward{background:#fff3cd;color:#856404;border:2px solid #ffc107;padding:12px 20px;border-radius:12px;font-size:20px;font-weight:700;text-align:center}
.footer{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-top:2px dashed #eee}
.qr-section{display:flex;align-items:center;gap:16px}
.qr-section img{width:120px;height:120px}
.qr-text{font-size:13px;color:#666;max-width:200px}
.contact-big{font-size:24px;font-weight:800;color:${bannerColor};text-align:right}
.contact-label{font-size:12px;color:#888;text-transform:uppercase;letter-spacing:1px}
.status-bar{text-align:center;padding:8px;font-size:13px;font-weight:600;color:${statusColor};border-top:1px solid #eee}
.tear-strips{display:flex;border-top:2px dashed #ccc;padding-top:8px}
.tear-strip{flex:1;text-align:center;border-right:1px dashed #ccc;padding:8px 4px;font-size:11px;writing-mode:vertical-rl;height:100px}
.tear-strip:last-child{border-right:none}
.tear-strip b{font-size:13px;color:${bannerColor}}
@media print{body{padding:20px} .no-break{page-break-inside:avoid}}
</style></head><body>
<div class="card no-break">
  <div class="banner">${loc.type==='danger'?'âš ï¸ DANGER ZONE':loc.type.startsWith('lost')?'ğŸ” '+typeLabel.toUpperCase():'ğŸ“‹ '+typeLabel.toUpperCase()}</div>
  <div class="body">
    ${loc.photo?`<img class="photo" src="${loc.photo}" alt="Photo">`:'<div class="no-photo">ğŸ“·</div>'}
    <div class="details">
      <div class="pet-name">${escapeHtml(loc.title||'(untitled)')}</div>
      <div class="info-row">
        <span class="info-pill">ğŸ“ ${loc.lat.toFixed(4)}, ${loc.lng.toFixed(4)}</span>
        <span class="info-pill" style="background:${statusColor}20;color:${statusColor}">${statusLabel(loc.status)}</span>
        ${loc.ownerUsername?`<span class="info-pill">ğŸ‘¤ ${escapeHtml(loc.ownerUsername)}</span>`:''}
      </div>
      ${loc.description?`<div class="desc">${escapeHtml(loc.description)}</div>`:''}
      ${loc.reward?`<div class="reward">ğŸ’° REWARD: ${escapeHtml(loc.reward)}</div>`:''}
    </div>
  </div>
  <div class="footer">
    <div class="qr-section">
      <img src="${qrUrl}" alt="QR Code">
      <div class="qr-text">Scan to view this pin on Lost Pins or visit:<br><b>${escapeHtml(shareUrl)}</b></div>
    </div>
    ${loc.contact?`<div><div class="contact-label">Contact</div><div class="contact-big">ğŸ“± ${escapeHtml(loc.contact)}</div></div>`:''}
  </div>
  <div class="status-bar">Posted on Lost Pins Â· ${new Date().toLocaleDateString()}</div>
</div>
${loc.contact?`
<div class="tear-strips no-break">
  ${'<div class="tear-strip"><b>'+escapeHtml(loc.contact)+'</b><br>'+escapeHtml(loc.title||'Lost')+'</div>'.repeat(7)}
</div>`:''}
</body></html>`);
      w.document.close();
      w.onload=()=>setTimeout(()=>w.print(),600);
    }

    /* ---------- Sightings ---------- */
    async function loadSightings(pinId){
      const container=document.getElementById('sightings-'+pinId); if(!container) return;
      try{
        const q=query(collection(db,'pins',pinId,'sightings'),orderBy('createdAt','desc'));
        const snap=await getDocs(q);
        if(snap.empty){ container.innerHTML='<div style="font-size:11px;color:var(--muted)">No sightings yet</div>'; return; }
        container.innerHTML='<div style="font-size:12px;color:var(--orange);font-weight:600;margin-bottom:4px">ğŸ‘ï¸ '+snap.size+' sighting'+(snap.size>1?'s':'')+':</div>';
        snap.forEach(d=>{
          const s=d.data();
          const div=document.createElement('div'); div.className='sighting-item';
          const ago=s.createdAt?timeAgo(s.createdAt):'just now';
          const who=s.reporterName||'Someone';
          const sAvatar=s.reporterAvatar||'';
          div.innerHTML=`${avatarHtml(sAvatar,who,'avatar-sm')} <b>${escapeHtml(who)}</b> Â· ${ago}${s.note?' â€” '+escapeHtml(s.note.slice(0,100)):''}${s.lat?' Â· <a href="#" onclick="event.preventDefault();map.flyTo(['+s.lat+','+s.lng+'],16,{duration:0.5})">ğŸ“ view</a>':''}`;
          container.appendChild(div);
        });
      }catch(e){ container.innerHTML=''; }
    }

    cancelSightingBtn.onclick=()=>{ sightingModal.hidden=true; state.sightingPinId=null; };
    sightingModal.addEventListener('click',(e)=>{ if(e.target===sightingModal){ sightingModal.hidden=true; state.sightingPinId=null; }});
    saveSightingBtn.onclick=async ()=>{
      const pinId=state.sightingPinId; if(!pinId) return;
      const user=auth.currentUser; if(!user) return;
      const note=sightingNote.value.trim();
      saveSightingBtn.disabled=true; saveSightingBtn.textContent='Submittingâ€¦';
      try{
        let lat=null,lng=null;
        if(navigator.geolocation){
          try{
            const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{timeout:5000}));
            lat=pos.coords.latitude; lng=pos.coords.longitude;
          }catch{}
        }
        await setDoc(doc(collection(db,'pins',pinId,'sightings')),{
          note, lat, lng,
          reporterUid:user.uid,
          reporterName:user.displayName||user.email?.split('@')[0]||'Anonymous',
          reporterAvatar:myAvatarB64||null,
          createdAt:serverTimestamp()
        });
        sightingModal.hidden=true; state.sightingPinId=null;
        // Refresh sightings in popup
        loadSightings(pinId);
        addXP(XP_VALUES.sighting,'Sighting reported');
        gamification.stats.sightings++;
        updateDoc(doc(db,'users',user.uid),{sightingsCount:(gamification.stats.sightings)}).catch(()=>{});
        checkAchievements();
      }catch(e){ alert(e?.message||'Failed to submit sighting.'); }
      saveSightingBtn.disabled=false; saveSightingBtn.textContent='Submit Sighting';
    };

    /* ---------- Browser Notifications ---------- */
    const notifState={enabled:false,userLat:null,userLng:null,seenPins:new Set(),radiusKm:5};
    const notifToggle=$('notifToggle'), notifRadius=$('notifRadius');

    function haversineKm(lat1,lng1,lat2,lng2){
      const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLng=(lng2-lng1)*Math.PI/180;
      const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    async function enableNotifications(){
      if(!('Notification' in window)){ alert('Your browser does not support notifications.'); return false; }
      const perm=await Notification.requestPermission();
      if(perm!=='granted'){ alert('Notification permission denied. Enable it in browser settings.'); return false; }
      // Get user location
      return new Promise(resolve=>{
        navigator.geolocation?.getCurrentPosition(
          pos=>{ notifState.userLat=pos.coords.latitude; notifState.userLng=pos.coords.longitude; resolve(true); },
          ()=>{ notifState.userLat=null; notifState.userLng=null; resolve(true); }, // still enable, just no location filter
          {enableHighAccuracy:true,timeout:8000}
        );
      });
    }

    function checkAndNotify(pin){
      if(!notifState.enabled) return;
      if(notifState.seenPins.has(pin.id)) return;
      notifState.seenPins.add(pin.id);
      // Skip own pins
      const user=auth.currentUser; if(user && pin.ownerUid===user.uid) return;
      // Distance check
      if(notifState.radiusKm>0 && notifState.userLat!=null){
        const d=haversineKm(notifState.userLat,notifState.userLng,pin.lat,pin.lng);
        if(d>notifState.radiusKm) return;
      }
      // Show notification
      const body=`${typeName(pin.type)} â€” ${pin.title||'New pin'}${pin.reward?' Â· ğŸ’° '+pin.reward:''}`;
      try{
        const n=new Notification('ğŸ” New Pin Nearby',{
          body, icon:pin.photo||undefined, tag:pin.id,
          data:{pinId:pin.id,lat:pin.lat,lng:pin.lng}
        });
        n.onclick=()=>{ window.focus(); map.flyTo([pin.lat,pin.lng],16,{duration:0.8}); const m=state.markers.get(pin.id); if(m) setTimeout(()=>m.openPopup(),900); };
      }catch{}
    }

    function updateNotifUI(){
      if(notifToggle){
        notifToggle.textContent=notifState.enabled?'ğŸ”” Alerts: On':'ğŸ”” Alerts: Off';
        notifToggle.classList.toggle('active',notifState.enabled);
      }
    }

    if(notifToggle) notifToggle.onclick=async()=>{
      if(notifState.enabled){ notifState.enabled=false; updateNotifUI(); localStorage.setItem('lostpins_notif','off'); return; }
      const ok=await enableNotifications();
      if(ok){ notifState.enabled=true; updateNotifUI(); localStorage.setItem('lostpins_notif','on');
        // Seed seen pins so we don't alert for existing ones
        state.locations.forEach(p=>notifState.seenPins.add(p.id));
      }
    };
    if(notifRadius) notifRadius.onchange=()=>{
      notifState.radiusKm=parseInt(notifRadius.value)||0;
      localStorage.setItem('lostpins_notif_radius',notifState.radiusKm);
    };
    // Restore notification prefs
    if(localStorage.getItem('lostpins_notif')==='on'){
      enableNotifications().then(ok=>{
        if(ok){ notifState.enabled=true; state.locations.forEach(p=>notifState.seenPins.add(p.id)); updateNotifUI(); }
      });
    }
    const savedRadius=localStorage.getItem('lostpins_notif_radius');
    if(savedRadius!=null){ notifState.radiusKm=parseInt(savedRadius)||0; if(notifRadius) notifRadius.value=String(notifState.radiusKm); }

    /* ---------- Time filter ---------- */
    function applyTimeFilter(){
      const now=Date.now();
      const cutoff=state.filterHours>0 ? now-(state.filterHours*3600000) : 0;
      for(const loc of state.locations){
        const m=state.markers.get(loc.id); if(!m) continue;
        const ts=loc.createdAt?.toMillis?loc.createdAt.toMillis():(loc.createdAt?.seconds?loc.createdAt.seconds*1000:now);
        if(ts>=cutoff){ if(!map.hasLayer(m)) m.addTo(map); }
        else { if(map.hasLayer(m)) map.removeLayer(m); }
      }
      renderList();
    }
    function isVisibleByFilter(loc){
      if(state.filterHours<=0) return true;
      const now=Date.now();
      const cutoff=now-(state.filterHours*3600000);
      const ts=loc.createdAt?.toMillis?loc.createdAt.toMillis():(loc.createdAt?.seconds?loc.createdAt.seconds*1000:now);
      return ts>=cutoff;
    }
    if(timeFilter){
      timeFilter.querySelectorAll('button').forEach(btn=>{
        btn.onclick=()=>{
          timeFilter.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          state.filterHours=parseInt(btn.dataset.hours)||0;
          localStorage.setItem('lostpins_filter',state.filterHours);
          applyTimeFilter();
        };
      });
    }

    /* ---------- Restore saved UI prefs ---------- */
    (function restorePrefs(){
      // Active pin type
      const savedMode=localStorage.getItem('lostpins_mode');
      if(savedMode && TYPES.includes(savedMode)){ state.activeType=savedMode; updateModeUI(); }
      // Time filter
      const savedFilter=localStorage.getItem('lostpins_filter');
      if(savedFilter!=null){
        state.filterHours=parseInt(savedFilter)||0;
        if(timeFilter){
          timeFilter.querySelectorAll('button').forEach(b=>{
            b.classList.toggle('active',String(parseInt(b.dataset.hours)||0)===String(state.filterHours));
          });
        }
      }
    })();

    /* ---------- Deep link (?pin=ID) ---------- */
    function checkDeepLink(){
      const params=new URLSearchParams(location.search);
      const pinId=params.get('pin');
      if(!pinId) return;
      const check=()=>{
        const loc=state.locations.find(x=>x.id===pinId);
        if(loc){
          map.flyTo([loc.lat,loc.lng],16,{duration:0.8});
          setTimeout(()=>{ const m=state.markers.get(loc.id); if(m) m.openPopup(); },900);
          return true;
        }
        return false;
      };
      if(!check()) setTimeout(check,2000); // retry after data loads
    }

    /* â•â•â•â•â•â• GAMIFICATION SYSTEM â•â•â•â•â•â• */
    const RANKS=[
      {name:'Scout',icon:'ğŸ”°',minXP:0},
      {name:'Tracker',icon:'ğŸ”',minXP:50},
      {name:'Ranger',icon:'ğŸ¹',minXP:150},
      {name:'Guardian',icon:'ğŸ›¡ï¸',minXP:400},
      {name:'Sentinel',icon:'âš”ï¸',minXP:800},
      {name:'Warden',icon:'ğŸ‘‘',minXP:1500},
      {name:'Commander',icon:'ğŸŒŸ',minXP:3000},
      {name:'Overlord',icon:'ğŸ’',minXP:6000}
    ];
    const ACHIEVEMENTS=[
      {id:'first_pin',name:'First Contact',desc:'Post your first pin',icon:'ğŸ“Œ',xp:15,check:(s)=>s.pins>=1},
      {id:'pins_5',name:'Cartographer',desc:'Post 5 pins',icon:'ğŸ—ºï¸',xp:30,check:(s)=>s.pins>=5},
      {id:'pins_20',name:'Network Builder',desc:'Post 20 pins',icon:'ğŸŒ',xp:75,check:(s)=>s.pins>=20},
      {id:'first_sight',name:'Eagle Eye',desc:'Report your first sighting',icon:'ğŸ‘ï¸',xp:15,check:(s)=>s.sightings>=1},
      {id:'sights_10',name:'Watchkeeper',desc:'Report 10 sightings',icon:'ğŸ”­',xp:50,check:(s)=>s.sightings>=10},
      {id:'first_resolve',name:'Reuniter',desc:'Mark a pin as Found',icon:'ğŸ’š',xp:40,check:(s)=>s.resolved>=1},
      {id:'resolve_5',name:'Hero of the Lost',desc:'Resolve 5 cases',icon:'ğŸ†',xp:100,check:(s)=>s.resolved>=5},
      {id:'all_types',name:'Versatile',desc:'Post every pin type',icon:'ğŸ¯',xp:50,check:(s)=>s.types>=5},
      {id:'xp_500',name:'Veteran',desc:'Earn 500 XP',icon:'â­',xp:0,check:(s)=>s.xp>=500},
      {id:'xp_2000',name:'Legend',desc:'Earn 2000 XP',icon:'ğŸŒŸ',xp:0,check:(s)=>s.xp>=2000},
    ];
    const XP_VALUES={pin:10,sighting:8,resolve:25};

    const gamification={
      xp:0, unlockedAchievements:new Set(), stats:{pins:0,sightings:0,resolved:0,types:0,xp:0}
    };

    function getRank(xp){
      let rank=RANKS[0];
      for(const r of RANKS){ if(xp>=r.minXP) rank=r; else break; }
      return rank;
    }
    function getNextRank(xp){
      for(const r of RANKS){ if(xp<r.minXP) return r; }
      return null;
    }
    function updateResourceBar(){
      const s=gamification.stats;
      const el=id=>document.getElementById(id);
      el('statPins').textContent=s.pins;
      el('statSightings').textContent=s.sightings;
      el('statResolved').textContent=s.resolved;
      el('statXP').textContent=s.xp;
      const rank=getRank(s.xp);
      const next=getNextRank(s.xp);
      el('rankIcon').textContent=rank.icon;
      el('rankTitle').textContent=rank.name.toUpperCase();
      if(next){
        const progress=((s.xp-rank.minXP)/(next.minXP-rank.minXP))*100;
        el('xpBarFill').style.width=Math.min(100,progress)+'%';
      } else {
        el('xpBarFill').style.width='100%';
      }
    }

    function showToast(icon,title,desc,xpGain){
      const container=document.getElementById('toastContainer'); if(!container) return;
      const toast=document.createElement('div'); toast.className='toast';
      toast.innerHTML=`
        <div class="toast-icon">${icon}</div>
        <div class="toast-body">
          <div class="toast-title">${title}</div>
          <div class="toast-desc">${desc}</div>
          ${xpGain?`<div class="toast-xp">+${xpGain} XP</div>`:''}
        </div>`;
      container.appendChild(toast);
      setTimeout(()=>{ toast.classList.add('out'); setTimeout(()=>toast.remove(),400); },4000);
    }

    function checkAchievements(){
      const s=gamification.stats;
      for(const a of ACHIEVEMENTS){
        if(gamification.unlockedAchievements.has(a.id)) continue;
        if(a.check(s)){
          gamification.unlockedAchievements.add(a.id);
          if(a.xp>0){ gamification.stats.xp+=a.xp; }
          showToast(a.icon,'Achievement Unlocked',a.name,a.xp||null);
          // Save unlocked achievements
          const user=auth.currentUser;
          if(user){ updateDoc(doc(db,'users',user.uid),{
            achievements:Array.from(gamification.unlockedAchievements),
            xp:gamification.stats.xp
          }).catch(()=>{}); }
        }
      }
      // Check for rank up
      const oldRank=gamification._lastRank;
      const newRank=getRank(gamification.stats.xp);
      if(oldRank && newRank.name!==oldRank.name){
        showToast(newRank.icon,'Rank Up!',`You are now: ${newRank.name}`,null);
      }
      gamification._lastRank=newRank;
      updateResourceBar();
    }

    function addXP(amount,reason){
      gamification.stats.xp+=amount;
      showToast('âš¡',`+${amount} XP`,reason,amount);
      checkAchievements();
    }

    function computeStats(){
      const user=auth.currentUser; if(!user) return;
      const uid=user.uid;
      const myPins=state.locations.filter(p=>p.ownerUid===uid);
      const resolved=myPins.filter(p=>p.status==='found').length;
      const typeSet=new Set(myPins.map(p=>p.type));
      gamification.stats.pins=myPins.length;
      gamification.stats.resolved=resolved;
      gamification.stats.types=typeSet.size;
      // xp is stored in firestore, don't recompute
      updateResourceBar();
      checkAchievements();
    }

    async function loadGamification(udoc){
      const data=udoc.data()||{};
      gamification.stats.xp=data.xp||0;
      gamification.stats.sightings=data.sightingsCount||0;
      gamification.unlockedAchievements=new Set(data.achievements||[]);
      gamification._lastRank=getRank(gamification.stats.xp);
      updateResourceBar();
    }

    let unsubPins=null,unsubUsers=null;
    function startPinsFeed(){
      if(unsubPins) return;
      const qPins=query(collection(db,'pins'),orderBy('createdAt','desc'));
      let isFirstSnap=true;
      unsubPins=onSnapshot(qPins,(snap)=>{
        const seen=new Set();
        snap.forEach(d=>{ const p={id:d.id,...d.data()}; seen.add(p.id); upsertLocalPin(p); if(!isFirstSnap) checkAndNotify(p); });
        isFirstSnap=false;
        for(const id of Array.from(state.markers.keys())) if(!seen.has(id)){ removeMarker(id); state.locations=state.locations.filter(x=>x.id!==id); }
        renderList(); applyTimeFilter(); computeStats();
      });
    }
    function stopFeeds(){ if(unsubPins){unsubPins();unsubPins=null;} if(unsubUsers){unsubUsers();unsubUsers=null;} }
    function startUsersFeed(){
      if(unsubUsers) return;
      const qUsers=query(collection(db,'users'),orderBy('createdAt','desc'));
      unsubUsers=onSnapshot(qUsers,(snap)=>{
        state.users=[]; snap.forEach(d=>state.users.push({id:d.id,...d.data()}));
        renderUsers();
      });
    }
    function timeAgo(ts){ if(!ts) return 'never'; const t=typeof ts.toMillis==='function'?ts.toMillis():(typeof ts==='number'?ts:Date.parse(ts)); const s=Math.max(0,Math.floor((Date.now()-t)/1000)); if(s<60) return s+'s ago'; const m=Math.floor(s/60); if(m<60) return m+'m ago'; const h=Math.floor(m/60); if(h<24) return h+'h ago'; const d=Math.floor(h/24); return d+'d ago'; }
    function renderUsers(){
      userList.innerHTML='';
      if(!state.users.length){ const li=document.createElement('li'); li.style.padding='8px'; li.textContent='No users yet.'; userList.appendChild(li); return; }
      const me=auth.currentUser; const now=Date.now();
      for(const u of state.users){
        const isOwner=(u.email||'').toLowerCase()===OWNER_EMAIL.toLowerCase();
        const isMod=['mod','moderator'].includes((u.role||'').toString().toLowerCase());
        const online=u.lastActiveAt && (now-(u.lastActiveAt.toMillis?u.lastActiveAt.toMillis():Date.parse(u.lastActiveAt)))<120000;

        const li=document.createElement('li'); li.style.padding='10px'; li.style.borderBottom='1px dashed #1f2433';
        const head=document.createElement('div'); head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center';
        const left=document.createElement('div'); left.innerHTML=`<div>${escapeHtml(u.email||'(unknown)')}</div><div style="font-size:12px;color:#9aa3ad"><span style="display:inline-block;width:8px;height:8px;border-radius:999px;margin-right:6px;background:${online?'#3ac97a':'#4b5563'}"></span>${online?'Online':'Last active '+timeAgo(u.lastActiveAt)}</div>`;
        const right=document.createElement('div');
        const roleTag=document.createElement('span'); roleTag.style.fontSize='10px'; roleTag.style.border='1px solid var(--border)'; roleTag.style.borderRadius='999px'; roleTag.style.padding='2px 6px'; roleTag.style.marginRight='6px';
        roleTag.textContent=isOwner?'owner':isMod?'mod':'';
        if(isOwner){ roleTag.style.borderColor='#bbf7d0'; roleTag.style.color='#15803d'; roleTag.style.background='#f0fdf4'; right.appendChild(roleTag); }
        else if(isMod){ roleTag.style.borderColor='#bfdbfe'; roleTag.style.color='#1d4ed8'; roleTag.style.background='#eff6ff'; right.appendChild(roleTag); }
        if(u.banned){ const b=document.createElement('span'); b.textContent='banned'; b.style.fontSize='10px'; b.style.marginRight='6px'; b.style.border='1px solid #fca5a5'; b.style.color='#dc2626'; b.style.borderRadius='999px'; b.style.padding='2px 6px'; b.style.background='#fef2f2'; right.appendChild(b); }
        const canBan=( ()=>{
          if(!me) return false;
          const iAmOwner=state.isAdmin; const iAmMod=state.isMod && !state.isAdmin;
          const targetIsSelf=u.id===me.uid;
          if(isOwner||targetIsSelf) return false;
          if(iAmOwner) return true;
          if(iAmMod) return !isMod;
          return false;
        })();
        if(state.isAdmin || state.isMod){
          const btn=document.createElement('button'); btn.className='danger'; btn.textContent=u.banned?'Unban':'Ban'; btn.disabled=!canBan;
          btn.onclick=async()=>{ try{ await updateDoc(doc(db,'users',u.id),{banned:!u.banned}); }catch(e){ alert(e?.message||'Permission denied (rules).'); } };
          right.appendChild(btn);
        }
        head.append(left,right); li.appendChild(head); userList.appendChild(li);
      }
    }

    /* ---------- Users modal open/close ---------- */
    function updateUsersButtons(){
      const show = state.isAdmin || state.isMod;
      if(openUsersBtn) openUsersBtn.style.display = show ? 'inline-block' : 'none';
      if(openUsersBtn_m) openUsersBtn_m.style.display = show ? 'inline-block' : 'none';
    }
    if(openUsersBtn) openUsersBtn.onclick=()=>{ usersModal.hidden=false; };
    if(openUsersBtn_m) openUsersBtn_m.onclick=()=>{ usersModal.hidden=false; };
    closeUsersBtn.onclick=()=>{ usersModal.hidden=true; };
    usersModal.addEventListener('click',(e)=>{ if(e.target===usersModal) usersModal.hidden=true; });

    /* ---------- Save (auth/terms) ---------- */
    if(openTermsLink) openTermsLink.addEventListener('click',(e)=>{ e.preventDefault(); termsModal.hidden=false; });
    let _postLoginConsentRef=null;
    agreeTermsBtn.onclick=async()=>{
      if(_postLoginConsentRef){
        try{ await updateDoc(_postLoginConsentRef,{terms:{accepted:true,version:TERMS_VERSION,acceptedAt:serverTimestamp()}}); termsModal.hidden=true; _postLoginConsentRef=null; const udoc=await getDoc(doc(db,'users',auth.currentUser.uid)); await finishLogin(auth.currentUser,udoc); }
        catch(e){ alert(e?.message||'Could not record consent.'); }
      }else{
        termsModal.hidden=true;
      }
    };
    closeTermsBtn.onclick=()=>{ termsModal.hidden=true; };

    /* ---------- Google sign-in ---------- */
    const provider=new GoogleAuthProvider(); provider.setCustomParameters({prompt:'select_account'});
    googleBtn.onclick=async()=>{
      gateError.textContent='';
      try{
        try{ await signInWithPopup(auth,provider); }
        catch(e){
          if(e?.code==='auth/popup-blocked'||e?.code==='auth/operation-not-supported-in-this-environment'){
            await signInWithRedirect(auth,provider);
          } else if(e?.code==='auth/popup-closed-by-user'){
            /* user closed it â€” do nothing */
          } else { throw e; }
        }
      }catch(e){ gateError.textContent=e?.code||e?.message||'Google signâ€‘in failed'; }
    };
    getRedirectResult(auth).catch(err=>{ gateError.textContent=err?.code||err?.message||'Google signâ€‘in failed'; });

    logoutBtn?.addEventListener('click',()=>signOut(auth));
    logoutBtnTop?.addEventListener('click',()=>signOut(auth));

    /* ---------- Auth state ---------- */
    onAuthStateChanged(auth, async (user)=>{
      if(state.hbTimer){ clearInterval(state.hbTimer); state.hbTimer=null; }
      stopFeeds(); state.users=[]; renderUsers(); clearMarkers();

      if(!user){
        document.body.classList.remove('auth'); whoami.textContent=''; whoamiTop.textContent='';
        myAvatarB64=null; if(profileRow) profileRow.style.display='none';
        return;
      }
      if(!isAllowedEmail(user.email)){ gateError.innerHTML=`This account (<b>${user.email}</b>) isnâ€™t allowed. Use your KAUST account.`; await signOut(auth); return; }

      // Unlock UI immediately
      document.body.classList.add('auth'); whoami.textContent=user.email; whoamiTop.textContent=user.email;

      // Ensure user profile
      const uref=doc(db,'users',user.uid); let udoc;
      try{
        udoc=await getDoc(uref);
        if(!udoc.exists()){
          await setDoc(uref,{email:user.email,createdAt:serverTimestamp(),role:null,banned:false,lastActiveAt:serverTimestamp()});
          udoc=await getDoc(uref);
        }
      }catch(e){ gateError.textContent='Account setup error: '+(e?.code||e?.message||e); return; }

      // Terms check
      const hasTerms=!!(udoc.data()?.terms && udoc.data().terms.accepted===true && udoc.data().terms.version===TERMS_VERSION);
      if(!hasTerms){
        try{
          const stash=JSON.parse(localStorage.getItem(CONSENT_STASH_KEY)||'null');
          if(stash?.accepted){ await updateDoc(uref,{terms:{accepted:true,version:TERMS_VERSION,acceptedAt:serverTimestamp()}}); localStorage.removeItem(CONSENT_STASH_KEY); udoc=await getDoc(uref); }
        }catch(_){}
      }
      if(!(udoc.data()?.terms && udoc.data().terms.accepted===true && udoc.data().terms.version===TERMS_VERSION)){
        _postLoginConsentRef=uref; termsModal.hidden=false;
        closeTermsBtn.onclick=async()=>{ termsModal.hidden=true; _postLoginConsentRef=null; await signOut(auth); document.body.classList.remove('auth'); };
        return;
      }

      await finishLogin(user,udoc);
    });

    async function finishLogin(user,udoc){
      const role=(udoc.data()?.role||'').toString().toLowerCase();
      state.isAdmin=(user.email||'').toLowerCase()===OWNER_EMAIL.toLowerCase();
      state.isMod=state.isAdmin || role==='mod' || role==='moderator';
      state.isBanned=!!udoc.data()?.banned;

      const tags=[]; if(state.isAdmin) tags.push('admin'); else if(state.isMod) tags.push('mod'); if(state.isBanned) tags.push('banned');
      whoami.textContent=user.email+(tags.length?' â€¢ '+tags.join(' â€¢ '):'');
      whoamiTop.textContent=user.email+(tags.length?' â€¢ '+tags.join(' â€¢ '):'');

      updateUsersButtons();

      // Load/create avatar
      const existingAvatar=udoc.data()?.avatarB64||null;
      const existingUrl=udoc.data()?.avatarUrl||null;
      if(existingAvatar){
        myAvatarB64=existingAvatar;
      } else if(user.photoURL){
        // Store Google photo URL as fallback
        const photoUrl=user.photoURL.replace(/=s\d+/,'=s64');
        if(!existingUrl){ await updateDoc(doc(db,'users',user.uid),{avatarUrl:photoUrl}).catch(()=>{}); }
        // Try to convert to base64 for offline/inline use
        try{
          const b64=await urlToBase64(photoUrl,64);
          if(b64){ myAvatarB64=b64; await updateDoc(doc(db,'users',user.uid),{avatarB64:b64}).catch(()=>{}); }
          else { myAvatarB64=photoUrl; } // use URL directly
        }catch{ myAvatarB64=photoUrl; }
      }
      updateProfileUI(user,myAvatarB64);
      await loadGamification(udoc);

      // presence heartbeat
      try{ await updateDoc(doc(db,'users',user.uid),{lastActiveAt:serverTimestamp()}); }catch{}
      state.hbTimer=setInterval(async()=>{ try{ await updateDoc(doc(db,'users',user.uid),{lastActiveAt:serverTimestamp()}); }catch{} },60000);
      window.addEventListener('visibilitychange',async()=>{ if(document.visibilityState==='visible'){ try{ await updateDoc(doc(db,'users',user.uid),{lastActiveAt:serverTimestamp()}); }catch{} } });

      // start data
      startPinsFeed();
      if(state.isAdmin||state.isMod) startUsersFeed();

      // Auto-locate on login
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          (pos)=>{ map.flyTo([pos.coords.latitude,pos.coords.longitude],14,{duration:1.2}); },
          ()=>{},
          {enableHighAccuracy:true,timeout:10000,maximumAge:300000}
        );
      }

      // Deep link
      setTimeout(checkDeepLink,1000);
      applyLang();
    }
  </script>
</body>
</html>
